(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{621:function(e,t,c){e.exports=c.p+"assets/img/baseapp_state_types.b1d93ad7.png"},622:function(e,t,c){e.exports=c.p+"assets/img/baseapp_state-initchain.28cdb535.png"},623:function(e,t,c){e.exports=c.p+"assets/img/baseapp_state-checktx.bbe754e7.png"},624:function(e,t,c){e.exports=c.p+"assets/img/baseapp_state-begin_block.60e8a1a8.png"},625:function(e,t,c){e.exports=c.p+"assets/img/baseapp_state-deliver_tx.d706bb70.png"},626:function(e,t,c){e.exports=c.p+"assets/img/baseapp_state-commit.fbc84e90.png"},684:function(e,t,c){"use strict";c.r(t);var a=c(1),o=Object(a.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"baseapp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#baseapp"}},[e._v("#")]),e._v(" Baseapp")]),e._v(" "),a("h2",{attrs:{hide:"",id:"pre-requisite-readings"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pre-requisite-readings"}},[e._v("#")]),e._v(" Pre-requisite Readings")]),e._v(" "),a("ul",[a("li",{attrs:{prereq:""}},[a("RouterLink",{attrs:{to:"/basics/app-anatomy.html"}},[e._v("Anatomy of an SDK application")])],1),e._v(" "),a("li",{attrs:{prereq:""}},[a("RouterLink",{attrs:{to:"/basics/tx-lifecycle.html"}},[e._v("Lifecycle of an SDK transaction")])],1)]),e._v(" "),a("h2",{attrs:{id:"introduction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),a("p",[a("code",[e._v("BaseApp")]),e._v(" is a base type that implements the core of an SDK application, namely:")]),e._v(" "),a("ul",[a("li",[e._v("The "),a("a",{attrs:{href:"#abci"}},[e._v("Application Blockchain Interface")]),e._v(", for the state-machine to communicate with the\nunderlying consensus engine (e.g. Tendermint).")]),e._v(" "),a("li",[e._v("A "),a("a",{attrs:{href:"#routing"}},[e._v("Router")]),e._v(", to route messages and queries to the appropriate module.")]),e._v(" "),a("li",[e._v("Different "),a("a",{attrs:{href:"#states"}},[e._v("states")]),e._v(", as the state-machine can have different volatile\nstates updated based on the ABCI message received.")])]),e._v(" "),a("p",[e._v("The goal of "),a("code",[e._v("BaseApp")]),e._v(" is to provide the fundamental layer of an SDK application\nthat developers can easily extend to build their own custom application. Usually,\ndevelopers will create a custom type for their application, like so:")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBBcHAgc3RydWN0IHsKICAvLyByZWZlcmVuY2UgdG8gYSBCYXNlQXBwCiAgKmJhbS5CYXNlQXBwCgogIC8vIGxpc3Qgb2YgYXBwbGljYXRpb24gc3RvcmUga2V5cwoKICAvLyBsaXN0IG9mIGFwcGxpY2F0aW9uIGtlZXBlcnMKCiAgLy8gbW9kdWxlIG1hbmFnZXIKfQo="}}),e._v(" "),a("p",[e._v("Extending the application with "),a("code",[e._v("BaseApp")]),e._v(" gives the former access to all of "),a("code",[e._v("BaseApp")]),e._v("'s methods.\nThis allows developers to compose their custom application with the modules they want, while not\nhaving to concern themselves with the hard work of implementing the ABCI, the routing and state\nmanagement logic.")]),e._v(" "),a("h2",{attrs:{id:"type-definition"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#type-definition"}},[e._v("#")]),e._v(" Type Definition")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("BaseApp")]),e._v(" type holds many important parameters for any Cosmos SDK based application.")]),e._v(" "),a("p",[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBCYXNlQXBwIHN0cnVjdCB7IC8vIG5vbGludDogbWFsaWduZWQKCS8vIGluaXRpYWxpemVkIG9uIGNyZWF0aW9uCglsb2dnZXIgICAgICBsb2cuTG9nZ2VyCgluYW1lICAgICAgICBzdHJpbmcgICAgICAgICAgICAgICAvLyBhcHBsaWNhdGlvbiBuYW1lIGZyb20gYWJjaS5JbmZvCglkYiAgICAgICAgICBkYm0uREIgICAgICAgICAgICAgICAvLyBjb21tb24gREIgYmFja2VuZAoJY21zICAgICAgICAgc2RrLkNvbW1pdE11bHRpU3RvcmUgLy8gTWFpbiAodW5jYWNoZWQpIHN0YXRlCglzdG9yZUxvYWRlciBTdG9yZUxvYWRlciAgICAgICAgICAvLyBmdW5jdGlvbiB0byBoYW5kbGUgc3RvcmUgbG9hZGluZywgbWF5IGJlIG92ZXJyaWRkZW4gd2l0aCBTZXRTdG9yZUxvYWRlcigpCglyb3V0ZXIgICAgICBzZGsuUm91dGVyICAgICAgICAgICAvLyBoYW5kbGUgYW55IGtpbmQgb2YgbWVzc2FnZQoJcXVlcnlSb3V0ZXIgc2RrLlF1ZXJ5Um91dGVyICAgICAgLy8gcm91dGVyIGZvciByZWRpcmVjdGluZyBxdWVyeSBjYWxscwoJdHhEZWNvZGVyICAgc2RrLlR4RGVjb2RlciAgICAgICAgLy8gdW5tYXJzaGFsIFtdYnl0ZSBpbnRvIHNkay5UeAoKCS8vIHNldCB1cG9uIExvYWRWZXJzaW9uIG9yIExvYWRMYXRlc3RWZXJzaW9uLgoJYmFzZUtleSAqc2RrLktWU3RvcmVLZXkgLy8gTWFpbiBLVlN0b3JlIGluIGNtcwoKCWFudGVIYW5kbGVyICAgIHNkay5BbnRlSGFuZGxlciAgLy8gYW50ZSBoYW5kbGVyIGZvciBmZWUgYW5kIGF1dGgKCWluaXRDaGFpbmVyICAgIHNkay5Jbml0Q2hhaW5lciAgLy8gaW5pdGlhbGl6ZSBzdGF0ZSB3aXRoIHZhbGlkYXRvcnMgYW5kIHN0YXRlIGJsb2IKCWJlZ2luQmxvY2tlciAgIHNkay5CZWdpbkJsb2NrZXIgLy8gbG9naWMgdG8gcnVuIGJlZm9yZSBhbnkgdHhzCgllbmRCbG9ja2VyICAgICBzZGsuRW5kQmxvY2tlciAgIC8vIGxvZ2ljIHRvIHJ1biBhZnRlciBhbGwgdHhzLCBhbmQgdG8gZGV0ZXJtaW5lIHZhbHNldCBjaGFuZ2VzCglhZGRyUGVlckZpbHRlciBzZGsuUGVlckZpbHRlciAgIC8vIGZpbHRlciBwZWVycyBieSBhZGRyZXNzIGFuZCBwb3J0CglpZFBlZXJGaWx0ZXIgICBzZGsuUGVlckZpbHRlciAgIC8vIGZpbHRlciBwZWVycyBieSBub2RlIElECglmYXV4TWVya2xlTW9kZSBib29sICAgICAgICAgICAgIC8vIGlmIHRydWUsIElBVkwgTW91bnRTdG9yZXMgdXNlcyBNb3VudFN0b3Jlc0RCIGZvciBzaW11bGF0aW9uIHNwZWVkLgoKCS8vIHZvbGF0aWxlIHN0YXRlczoKCS8vCgkvLyBjaGVja1N0YXRlIGlzIHNldCBvbiBJbml0Q2hhaW4gYW5kIHJlc2V0IG9uIENvbW1pdAoJLy8gZGVsaXZlclN0YXRlIGlzIHNldCBvbiBJbml0Q2hhaW4gYW5kIEJlZ2luQmxvY2sgYW5kIHNldCB0byBuaWwgb24gQ29tbWl0CgljaGVja1N0YXRlICAgKnN0YXRlIC8vIGZvciBDaGVja1R4CglkZWxpdmVyU3RhdGUgKnN0YXRlIC8vIGZvciBEZWxpdmVyVHgKCgkvLyBhbiBpbnRlci1ibG9jayB3cml0ZS10aHJvdWdoIGNhY2hlIHByb3ZpZGVkIHRvIHRoZSBjb250ZXh0IGR1cmluZyBkZWxpdmVyU3RhdGUKCWludGVyQmxvY2tDYWNoZSBzZGsuTXVsdGlTdG9yZVBlcnNpc3RlbnRDYWNoZQoKCS8vIGFic2VudCB2YWxpZGF0b3JzIGZyb20gYmVnaW4gYmxvY2sKCXZvdGVJbmZvcyBbXWFiY2kuVm90ZUluZm8KCgkvLyBjb25zZW5zdXMgcGFyYW1zCgkvLyBUT0RPOiBNb3ZlIHRoaXMgaW4gdGhlIGZ1dHVyZSB0byBiYXNlYXBwIHBhcmFtIHN0b3JlIG9uIG1haW4gc3RvcmUuCgljb25zZW5zdXNQYXJhbXMgKmFiY2kuQ29uc2Vuc3VzUGFyYW1zCgoJLy8gVGhlIG1pbmltdW0gZ2FzIHByaWNlcyBhIHZhbGlkYXRvciBpcyB3aWxsaW5nIHRvIGFjY2VwdCBmb3IgcHJvY2Vzc2luZyBhCgkvLyB0cmFuc2FjdGlvbi4gVGhpcyBpcyBtYWlubHkgdXNlZCBmb3IgRG9TIGFuZCBzcGFtIHByZXZlbnRpb24uCgltaW5HYXNQcmljZXMgc2RrLkRlY0NvaW5zCgoJLy8gZmxhZyBmb3Igc2VhbGluZyBvcHRpb25zIGFuZCBwYXJhbWV0ZXJzIHRvIGEgQmFzZUFwcAoJc2VhbGVkIGJvb2wKCgkvLyBibG9jayBoZWlnaHQgYXQgd2hpY2ggdG8gaGFsdCB0aGUgY2hhaW4gYW5kIGdyYWNlZnVsbHkgc2h1dGRvd24KCWhhbHRIZWlnaHQgdWludDY0CgoJLy8gbWluaW11bSBibG9jayB0aW1lIChpbiBVbml4IHNlY29uZHMpIGF0IHdoaWNoIHRvIGhhbHQgdGhlIGNoYWluIGFuZCBncmFjZWZ1bGx5IHNodXRkb3duCgloYWx0VGltZSB1aW50NjQKCgkvLyBhcHBsaWNhdGlvbidzIHZlcnNpb24gc3RyaW5nCglhcHBWZXJzaW9uIHN0cmluZwp9"}})],1),e._v(" "),a("p",[e._v("Let us go through the most important components.")]),e._v(" "),a("blockquote",[a("p",[a("strong",[e._v("Note")]),e._v(": Not all parameters are described, only the most important ones. Refer to the\ntype definition for the full list.")])]),e._v(" "),a("p",[e._v("First, the important parameters that are initialized during the bootstrapping of the application:")]),e._v(" "),a("ul",[a("li",[a("RouterLink",{attrs:{to:"/core/store.html#commitmultistore"}},[a("code",[e._v("CommitMultiStore")])]),e._v(": This is the main store of the application,\nwhich holds the canonical state that is committed at the "),a("a",{attrs:{href:"#commit"}},[e._v("end of each block")]),e._v(". This store\nis "),a("strong",[e._v("not")]),e._v(" cached, meaning it is not used to update the application's volatile (un-committed) states.\nThe "),a("code",[e._v("CommitMultiStore")]),e._v(" is a multi-store, meaning a store of stores. Each module of the application\nuses one or multiple "),a("code",[e._v("KVStores")]),e._v(" in the multi-store to persist their subset of the state.")],1),e._v(" "),a("li",[e._v("Database: The "),a("code",[e._v("db")]),e._v(" is used by the "),a("code",[e._v("CommitMultiStore")]),e._v(" to handle data persistence.")]),e._v(" "),a("li",[a("a",{attrs:{href:"#message-routing"}},[e._v("Router")]),e._v(": The "),a("code",[e._v("router")]),e._v(" facilitates the routing of "),a("code",[e._v("messages")]),e._v(" to the appropriate\nmodule for it to be processed. Here a "),a("code",[e._v("message")]),e._v(" refers to the transaction components that need to be\nprocessed by the application in order to update the state, and not to ABCI messages which implement\nthe interface between the application and the underlying consensus engine.")]),e._v(" "),a("li",[a("a",{attrs:{href:"#query-routing"}},[e._v("Query Router")]),e._v(": The "),a("code",[e._v("query router")]),e._v(" facilitates the routing of queries to the\nappropriate module for it to be processed. These "),a("code",[e._v("queries")]),e._v(" are not ABCI messages themselves, but they\nare relayed to the application from the underlying consensus engine via the ABCI message "),a("a",{attrs:{href:"#query"}},[a("code",[e._v("Query")])]),e._v(".")]),e._v(" "),a("li",[a("a",{attrs:{href:"https://godoc.org/github.com/cosmos/cosmos-sdk/types#TxDecoder",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("TxDecoder")]),a("OutboundLink")],1),e._v(": It is used to decode\nraw transaction bytes relayed by the underlying Tendermint engine.")]),e._v(" "),a("li",[a("code",[e._v("BaseKey")]),e._v(": This key is used to access the main store in the "),a("code",[e._v("CommitMultiStore")]),e._v(". The main store is\nused to persist data related to the core of the application, like consensus parameters.")]),e._v(" "),a("li",[a("a",{attrs:{href:"#antehandler"}},[a("code",[e._v("AnteHandler")])]),e._v(": This handler is used to handle signature verification, fee payment,\nand other pre-message execution checks when a transaction is received. It's executed during\n"),a("a",{attrs:{href:"#checktx"}},[a("code",[e._v("CheckTx/RecheckTx")])]),e._v(" and "),a("a",{attrs:{href:"#delivertx"}},[a("code",[e._v("DeliverTx")])]),e._v(".")]),e._v(" "),a("li",[a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#initchainer"}},[a("code",[e._v("InitChainer")])]),e._v(",\n"),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#beginblocker-and-endblocker"}},[a("code",[e._v("BeginBlocker")]),e._v(" and "),a("code",[e._v("EndBlocker")])]),e._v(": These are\nthe functions executed when the application receives the "),a("code",[e._v("InitChain")]),e._v(", "),a("code",[e._v("BeginBlock")]),e._v(" and "),a("code",[e._v("EndBlock")]),e._v("\nABCI messages from the underlying Tendermint engine.")],1)]),e._v(" "),a("p",[e._v("Then, parameters used to define "),a("a",{attrs:{href:"#volatile-states"}},[e._v("volatile states")]),e._v(" (i.e. cached states):")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("checkState")]),e._v(": This state is updated during "),a("a",{attrs:{href:"#checktx"}},[a("code",[e._v("CheckTx")])]),e._v(", and reset on "),a("a",{attrs:{href:"#commit"}},[a("code",[e._v("Commit")])]),e._v(".")]),e._v(" "),a("li",[a("code",[e._v("deliverState")]),e._v(": This state is updated during "),a("a",{attrs:{href:"#delivertx"}},[a("code",[e._v("DeliverTx")])]),e._v(", and set to "),a("code",[e._v("nil")]),e._v(" on\n"),a("a",{attrs:{href:"#commit"}},[a("code",[e._v("Commit")])]),e._v(" and gets re-initialized on BeginBlock.")])]),e._v(" "),a("p",[e._v("Finally, a few more important parameterd:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("voteInfos")]),e._v(": This parameter carries the list of validators whose precommit is missing, either\nbecause they did not vote or because the proposer did not include their vote. This information is\ncarried by the "),a("a",{attrs:{href:"#context"}},[e._v("Context")]),e._v(" and can be used by the application for various things like\npunishing absent validators.")]),e._v(" "),a("li",[a("code",[e._v("minGasPrices")]),e._v(": This parameter defines the minimum gas prices accepted by the node. This is a\n"),a("strong",[e._v("local")]),e._v(" parameter, meaning each full-node can set a different "),a("code",[e._v("minGasPrices")]),e._v(". It is used in the\n"),a("code",[e._v("AnteHandler")]),e._v(" during "),a("a",{attrs:{href:"#checktx"}},[a("code",[e._v("CheckTx")])]),e._v(", mainly as a spam protection mechanism. The transaction\nenters the "),a("a",{attrs:{href:"https://tendermint.com/docs/tendermint-core/mempool.html#transaction-ordering",target:"_blank",rel:"noopener noreferrer"}},[e._v("mempool"),a("OutboundLink")],1),e._v("\nonly if the gas prices of the transaction are greater than one of the minimum gas price in\n"),a("code",[e._v("minGasPrices")]),e._v(" (e.g. if "),a("code",[e._v("minGasPrices == 1uatom,1photon")]),e._v(", the "),a("code",[e._v("gas-price")]),e._v(" of the transaction must be\ngreater than "),a("code",[e._v("1uatom")]),e._v(" OR "),a("code",[e._v("1photon")]),e._v(").")]),e._v(" "),a("li",[a("code",[e._v("appVersion")]),e._v(": Version of the application. It is set in the\n"),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#constructor-function"}},[e._v("application's constructor function")]),e._v(".")],1)]),e._v(" "),a("h2",{attrs:{id:"constructor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#constructor"}},[e._v("#")]),e._v(" Constructor")]),e._v(" "),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBOZXdCYXNlQXBwKAogIG5hbWUgc3RyaW5nLCBsb2dnZXIgbG9nLkxvZ2dlciwgZGIgZGJtLkRCLCB0eERlY29kZXIgc2RrLlR4RGVjb2Rlciwgb3B0aW9ucyAuLi5mdW5jKCpCYXNlQXBwKSwKKSAqQmFzZUFwcCB7CgogIC8vIC4uLgp9Cg=="}}),e._v(" "),a("p",[e._v("The "),a("code",[e._v("BaseApp")]),e._v(" constructor function is pretty straightforward. The only thing worth noting is the\npossibility to provide additional "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/baseapp/options.go",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("options")]),a("OutboundLink")],1),e._v("\nto the "),a("code",[e._v("BaseApp")]),e._v(", which will execute them in order. The "),a("code",[e._v("options")]),e._v(" are generally "),a("code",[e._v("setter")]),e._v(" functions\nfor important parameters, like "),a("code",[e._v("SetPruning()")]),e._v(" to set pruning options or "),a("code",[e._v("SetMinGasPrices()")]),e._v(" to set\nthe node's "),a("code",[e._v("min-gas-prices")]),e._v(".")]),e._v(" "),a("p",[e._v("Naturally, developers can add additional "),a("code",[e._v("options")]),e._v(" based on their application's needs.")]),e._v(" "),a("h2",{attrs:{id:"state-updates"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#state-updates"}},[e._v("#")]),e._v(" State Updates")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("BaseApp")]),e._v(" maintains two primary volatile states and a root or main state. The main state\nis the canonical state of the application and the volatile states, "),a("code",[e._v("checkState")]),e._v(" and "),a("code",[e._v("deliverState")]),e._v(",\nare used to handle state transitions in-between the main state made during "),a("a",{attrs:{href:"#commit"}},[a("code",[e._v("Commit")])]),e._v(".")]),e._v(" "),a("p",[e._v("Internally, there is only a single "),a("code",[e._v("CommitMultiStore")]),e._v(" which we refer to as the main or root state.\nFrom this root state, we derive two volatile state through a mechanism called cache-wrapping. The\ntypes can be illustrated as follows:")]),e._v(" "),a("p",[a("img",{attrs:{src:c(621),alt:"Types"}})]),e._v(" "),a("h3",{attrs:{id:"initchain-state-updates"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#initchain-state-updates"}},[e._v("#")]),e._v(" InitChain State Updates")]),e._v(" "),a("p",[e._v("During "),a("code",[e._v("InitChain")]),e._v(", the two volatile states, "),a("code",[e._v("checkState")]),e._v(" and "),a("code",[e._v("deliverState")]),e._v(" are set by cache-wrapping\nthe root "),a("code",[e._v("CommitMultiStore")]),e._v(". Any subsequent reads and writes happen on cached versions of the "),a("code",[e._v("CommitMultiStore")]),e._v(".")]),e._v(" "),a("p",[a("img",{attrs:{src:c(622),alt:"InitChain"}})]),e._v(" "),a("h3",{attrs:{id:"checktx-state-updates"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#checktx-state-updates"}},[e._v("#")]),e._v(" CheckTx State Updates")]),e._v(" "),a("p",[e._v("During "),a("code",[e._v("CheckTx")]),e._v(", the "),a("code",[e._v("checkState")]),e._v(", which is based off of the last committed state from the root\nstore, is used for any reads and writes. Here we only execute the "),a("code",[e._v("AnteHandler")]),e._v(" and verify a router\nexists for every message in the transaction. Note, when we execute the "),a("code",[e._v("AnteHandler")]),e._v(", we cache-wrap\nthe already cache-wrapped "),a("code",[e._v("checkState")]),e._v(". This has the side effect that if the "),a("code",[e._v("AnteHandler")]),e._v(" fails,\nthe state transitions won't be reflected in the "),a("code",[e._v("checkState")]),e._v(" -- i.e. "),a("code",[e._v("checkState")]),e._v(" is only updated on\nsuccess.")]),e._v(" "),a("p",[a("img",{attrs:{src:c(623),alt:"CheckTx"}})]),e._v(" "),a("h3",{attrs:{id:"beginblock-state-updates"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#beginblock-state-updates"}},[e._v("#")]),e._v(" BeginBlock State Updates")]),e._v(" "),a("p",[e._v("During "),a("code",[e._v("BeginBlock")]),e._v(", the "),a("code",[e._v("deliverState")]),e._v(" is set for use in subsequent "),a("code",[e._v("DeliverTx")]),e._v(" ABCI messages. The\n"),a("code",[e._v("deliverState")]),e._v(" is based off of the last committed state from the root store and is cache-wrapped.\nNote, the "),a("code",[e._v("deliverState")]),e._v(" is set to "),a("code",[e._v("nil")]),e._v(" on "),a("a",{attrs:{href:"#commit"}},[a("code",[e._v("Commit")])]),e._v(".")]),e._v(" "),a("p",[a("img",{attrs:{src:c(624),alt:"BeginBlock"}})]),e._v(" "),a("h3",{attrs:{id:"delivertx-state-updates"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#delivertx-state-updates"}},[e._v("#")]),e._v(" DeliverTx State Updates")]),e._v(" "),a("p",[e._v("The state flow for "),a("code",[e._v("DeliverTx")]),e._v(" is nearly identical to "),a("code",[e._v("CheckTx")]),e._v(" except state transitions occur on\nthe "),a("code",[e._v("deliverState")]),e._v(" and messages in a transaction are executed. Similarly to "),a("code",[e._v("CheckTx")]),e._v(", state transitions\noccur on a doubly cache-wrapped state -- "),a("code",[e._v("deliverState")]),e._v(". Successful message execution results in\nwrites being committed to "),a("code",[e._v("deliverState")]),e._v(". Note, if message execution fails, state transitions from\nthe AnteHandler are persisted.")]),e._v(" "),a("p",[a("img",{attrs:{src:c(625),alt:"DeliverTx"}})]),e._v(" "),a("h3",{attrs:{id:"commit-state-updates"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commit-state-updates"}},[e._v("#")]),e._v(" Commit State Updates")]),e._v(" "),a("p",[e._v("During "),a("code",[e._v("Commit")]),e._v(" all the state transitions that occurred in the "),a("code",[e._v("deliverState")]),e._v(" are finally written to\nthe root "),a("code",[e._v("CommitMultiStore")]),e._v(" which in turn is committed to disk and results in a new application\nroot hash. These state transitions are now considered final. Finally, the "),a("code",[e._v("checkState")]),e._v(" is set to the\nnewly committed state and "),a("code",[e._v("deliverState")]),e._v(" is set to "),a("code",[e._v("nil")]),e._v(" to be reset on "),a("code",[e._v("BeginBlock")]),e._v(".")]),e._v(" "),a("p",[a("img",{attrs:{src:c(626),alt:"Commit"}})]),e._v(" "),a("h2",{attrs:{id:"routing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#routing"}},[e._v("#")]),e._v(" Routing")]),e._v(" "),a("p",[e._v("When messages and queries are received by the application, they must be routed to the appropriate module in order to be processed. Routing is done via "),a("code",[e._v("baseapp")]),e._v(", which holds a "),a("code",[e._v("router")]),e._v(" for messages, and a "),a("code",[e._v("query router")]),e._v(" for queries.")]),e._v(" "),a("h3",{attrs:{id:"message-routing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#message-routing"}},[e._v("#")]),e._v(" Message Routing")]),e._v(" "),a("p",[a("RouterLink",{attrs:{to:"/core/baseapp.html#../building-modules/messages-and-queries.md#messages"}},[a("code",[e._v("Message")]),e._v("s")]),e._v(" need to be routed after they are extracted from transactions, which are sent from the underlying Tendermint engine via the "),a("a",{attrs:{href:"#checktx"}},[a("code",[e._v("CheckTx")])]),e._v(" and "),a("a",{attrs:{href:"#delivertx"}},[a("code",[e._v("DeliverTx")])]),e._v(" ABCI messages. To do so, "),a("code",[e._v("baseapp")]),e._v(" holds a "),a("code",[e._v("router")]),e._v(" which maps "),a("code",[e._v("paths")]),e._v(" ("),a("code",[e._v("string")]),e._v(") to the appropriate module "),a("RouterLink",{attrs:{to:"/building-modules/handler.html"}},[a("code",[e._v("handler")])]),e._v(" using the "),a("code",[e._v(".Route(ctx sdk.Context, path string)")]),e._v(" function. Usually, the "),a("code",[e._v("path")]),e._v(" is the name of the module.")],1),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/master/baseapp/router.go",target:"_blank",rel:"noopener noreferrer"}},[e._v("default router included in baseapp"),a("OutboundLink")],1),e._v(" is stateless.  However, some applications may want to make use of more stateful routing mechanisms such as allowing governance to disable certain routes or point them to new modules for upgrade purposes.  For this reason, the "),a("code",[e._v("sdk.Context")]),e._v(" is also passed into the "),a("code",[e._v("Route")]),e._v(" function of the "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/master/types/router.go#L12",target:"_blank",rel:"noopener noreferrer"}},[e._v("Router interface"),a("OutboundLink")],1),e._v(".  For a stateless router that doesn't want to make use of this, can just ignore the ctx.")]),e._v(" "),a("p",[e._v("The application's "),a("code",[e._v("router")]),e._v(" is initilalized with all the routes using the application's "),a("RouterLink",{attrs:{to:"/building-modules/module-manager.html#manager"}},[e._v("module manager")]),e._v(", which itself is initialized with all the application's modules in the application's "),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#app-constructor"}},[e._v("constructor")]),e._v(".")],1),e._v(" "),a("h3",{attrs:{id:"query-routing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#query-routing"}},[e._v("#")]),e._v(" Query Routing")]),e._v(" "),a("p",[e._v("Similar to "),a("code",[e._v("message")]),e._v("s, "),a("RouterLink",{attrs:{to:"/building-modules/messages-and-queries.html#queries"}},[a("code",[e._v("queries")])]),e._v(" need to be routed to the appropriate module's "),a("RouterLink",{attrs:{to:"/building-modules/querier.html"}},[e._v("querier")]),e._v(". To do so, "),a("code",[e._v("baseapp")]),e._v(" holds a "),a("code",[e._v("query router")]),e._v(", which maps module names to module "),a("code",[e._v("querier")]),e._v("s. The "),a("code",[e._v("queryRouter")]),e._v(" is called during the initial stages of "),a("code",[e._v("query")]),e._v(" processing, which is done via the "),a("a",{attrs:{href:"#query"}},[a("code",[e._v("Query")]),e._v(" ABCI message")]),e._v(".")],1),e._v(" "),a("p",[e._v("Just like the "),a("code",[e._v("router")]),e._v(", the "),a("code",[e._v("query router")]),e._v(" is initilalized with all the query routes using the application's "),a("RouterLink",{attrs:{to:"/building-modules/module-manager.html"}},[e._v("module manager")]),e._v(", which itself is initialized with all the application's modules in the application's "),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#app-constructor"}},[e._v("constructor")]),e._v(".")],1),e._v(" "),a("h2",{attrs:{id:"main-abci-messages"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#main-abci-messages"}},[e._v("#")]),e._v(" Main ABCI Messages")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://tendermint.com/docs/spec/abci/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Application-Blockchain Interface"),a("OutboundLink")],1),e._v(" (ABCI) is a generic interface that connects a state-machine with a consensus engine to form a functional full-node. It can be wrapped in any language, and needs to be implemented by each application-specific blockchain built on top of an ABCI-compatible consensus engine like Tendermint.")]),e._v(" "),a("p",[e._v("The consensus engine handles two main tasks:")]),e._v(" "),a("ul",[a("li",[e._v("The networking logic, which mainly consists in gossiping block parts, transactions and consensus votes.")]),e._v(" "),a("li",[e._v("The consensus logic, which results in the deterministic ordering of transactions in the form of blocks.")])]),e._v(" "),a("p",[e._v("It is "),a("strong",[e._v("not")]),e._v(" the role of the consensus engine to define the state or the validity of transactions. Generally, transactions are handled by the consensus engine in the form of "),a("code",[e._v("[]bytes")]),e._v(", and relayed to the application via the ABCI to be decoded and processed. At keys moments in the networking and consensus processes (e.g. beginning of a block, commit of a block, reception of an unconfirmed transaction, ...), the consensus engine emits ABCI messages for the state-machine to act on.")]),e._v(" "),a("p",[e._v("Developers building on top of the Cosmos SDK need not implement the ABCI themselves, as "),a("code",[e._v("baseapp")]),e._v(" comes with a built-in implementation of the interface. Let us go through the main ABCI messages that "),a("code",[e._v("baseapp")]),e._v(" implements: "),a("a",{attrs:{href:"#checktx"}},[a("code",[e._v("CheckTx")])]),e._v(" and "),a("a",{attrs:{href:"#delivertx"}},[a("code",[e._v("DeliverTx")])])]),e._v(" "),a("h3",{attrs:{id:"checktx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#checktx"}},[e._v("#")]),e._v(" CheckTx")]),e._v(" "),a("p",[a("code",[e._v("CheckTx")]),e._v(" is sent by the underlying consensus engine when a new unconfirmed (i.e. not yet included in a valid block)\ntransaction is received by a full-node. The role of "),a("code",[e._v("CheckTx")]),e._v(" is to guard the full-node's mempool\n(where unconfirmed transactions are stored until they are included in a block) from spam transactions.\nUnconfirmed transactions are relayed to peers only if they pass "),a("code",[e._v("CheckTx")]),e._v(".")]),e._v(" "),a("p",[a("code",[e._v("CheckTx()")]),e._v(" can perform both "),a("em",[e._v("stateful")]),e._v(" and "),a("em",[e._v("stateless")]),e._v(" checks, but developers should strive to\nmake them lightweight. In the Cosmos SDK, after "),a("RouterLink",{attrs:{to:"/core/encoding.html"}},[e._v("decoding transactions")]),e._v(", "),a("code",[e._v("CheckTx()")]),e._v(" is implemented\nto do the following checks:")],1),e._v(" "),a("ol",[a("li",[e._v("Extract the "),a("code",[e._v("message")]),e._v("s from the transaction.")]),e._v(" "),a("li",[e._v("Perform "),a("em",[e._v("stateless")]),e._v(" checks by calling "),a("code",[e._v("ValidateBasic()")]),e._v(" on each of the "),a("code",[e._v("messages")]),e._v(". This is done\nfirst, as "),a("em",[e._v("stateless")]),e._v(" checks are less computationally expensive than "),a("em",[e._v("stateful")]),e._v(" checks. If\n"),a("code",[e._v("ValidateBasic()")]),e._v(" fail, "),a("code",[e._v("CheckTx")]),e._v(" returns before running "),a("em",[e._v("stateful")]),e._v(" checks, which saves resources.")]),e._v(" "),a("li",[e._v("Perform non-module related "),a("em",[e._v("stateful")]),e._v(" checks on the "),a("RouterLink",{attrs:{to:"/basics/accounts.html"}},[e._v("account")]),e._v(". This step is mainly about checking\nthat the "),a("code",[e._v("message")]),e._v(" signatures are valid, that enough fees are provided and that the sending account\nhas enough funds to pay for said fees. Note that no precise "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html"}},[a("code",[e._v("gas")])]),e._v(" counting occurs here,\nas "),a("code",[e._v("message")]),e._v("s are not processed. Usually, the "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html#antehandler"}},[a("code",[e._v("AnteHandler")])]),e._v(" will check that the "),a("code",[e._v("gas")]),e._v(" provided\nwith the transaction is superior to a minimum reference gas amount based on the raw transaction size,\nin order to avoid spam with transactions that provide 0 gas.")],1),e._v(" "),a("li",[e._v("Ensure that a "),a("a",{attrs:{href:"#message-routing"}},[a("code",[e._v("Route")])]),e._v(" exists for each "),a("code",[e._v("message")]),e._v(", but do "),a("strong",[e._v("not")]),e._v(" actually\nprocess "),a("code",[e._v("message")]),e._v("s. "),a("code",[e._v("Message")]),e._v("s only need to be processed when the canonical state need to be updated,\nwhich happens during "),a("code",[e._v("DeliverTx")]),e._v(".")])]),e._v(" "),a("p",[e._v("Steps 2. and 3. are performed by the "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html#antehandler"}},[a("code",[e._v("AnteHandler")])]),e._v(" in the "),a("a",{attrs:{href:"#runtx-antehandler-and-runmsgs"}},[a("code",[e._v("RunTx()")])]),e._v("\nfunction, which "),a("code",[e._v("CheckTx()")]),e._v(" calls with the "),a("code",[e._v("runTxModeCheck")]),e._v(" mode. During each step of "),a("code",[e._v("CheckTx()")]),e._v(", a\nspecial "),a("a",{attrs:{href:"#volatile-states"}},[e._v("volatile state")]),e._v(" called "),a("code",[e._v("checkState")]),e._v(" is updated. This state is used to keep\ntrack of the temporary changes triggered by the "),a("code",[e._v("CheckTx()")]),e._v(" calls of each transaction without modifying\nthe "),a("a",{attrs:{href:"#main-state"}},[e._v("main canonical state")]),e._v(" . For example, when a transaction goes through "),a("code",[e._v("CheckTx()")]),e._v(", the\ntransaction's fees are deducted from the sender's account in "),a("code",[e._v("checkState")]),e._v(". If a second transaction is\nreceived from the same account before the first is processed, and the account has consumed all its\nfunds in "),a("code",[e._v("checkState")]),e._v(" during the first transaction, the second transaction will fail "),a("code",[e._v("CheckTx")]),e._v("() and\nbe rejected. In any case, the sender's account will not actually pay the fees until the transaction\nis actually included in a block, because "),a("code",[e._v("checkState")]),e._v(" never gets committed to the main state. The\n"),a("code",[e._v("checkState")]),e._v(" is reset to the latest state of the main state each time a blocks gets "),a("a",{attrs:{href:"#commit"}},[e._v("committed")]),e._v(".")],1),e._v(" "),a("p",[a("code",[e._v("CheckTx")]),e._v(" returns a response to the underlying consensus engine of type "),a("a",{attrs:{href:"https://tendermint.com/docs/spec/abci/abci.html#messages",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("abci.ResponseCheckTx")]),a("OutboundLink")],1),e._v(".\nThe response contains:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("Code (uint32)")]),e._v(": Response Code. "),a("code",[e._v("0")]),e._v(" if successful.")]),e._v(" "),a("li",[a("code",[e._v("Data ([]byte)")]),e._v(": Result bytes, if any.")]),e._v(" "),a("li",[a("code",[e._v("Log (string):")]),e._v(" The output of the application's logger. May be non-deterministic.")]),e._v(" "),a("li",[a("code",[e._v("Info (string):")]),e._v(" Additional information. May be non-deterministic.")]),e._v(" "),a("li",[a("code",[e._v("GasWanted (int64)")]),e._v(": Amount of gas requested for transaction. It is provided by users when they generate the transaction.")]),e._v(" "),a("li",[a("code",[e._v("GasUsed (int64)")]),e._v(": Amount of gas consumed by transaction. During "),a("code",[e._v("CheckTx")]),e._v(", this value is computed by multiplying the standard cost of a transaction byte by the size of the raw transaction. Next is an example:\n"),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBhbnRlCgppbXBvcnQgKAoJc2RrICZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvdHlwZXMmcXVvdDsKCWVyciAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3R5cGVzL2Vycm9ycyZxdW90OwoJc2RrZXJyb3JzICZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvdHlwZXMvZXJyb3JzJnF1b3Q7CgoJJnF1b3Q7Z2l0aHViLmNvbS90ZW5kZXJtaW50L3RlbmRlcm1pbnQvY3J5cHRvJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL3RlbmRlcm1pbnQvdGVuZGVybWludC9jcnlwdG8vbXVsdGlzaWcmcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3gvYXV0aC9rZWVwZXImcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsveC9hdXRoL3R5cGVzJnF1b3Q7CikKCnZhciAoCglfIFR4V2l0aE1lbW8gPSAoKnR5cGVzLlN0ZFR4KShuaWwpIC8vIGFzc2VydCBTdGRUeCBpbXBsZW1lbnRzIFR4V2l0aE1lbW8KKQoKLy8gVmFsaWRhdGVCYXNpY0RlY29yYXRvciB3aWxsIGNhbGwgdHguVmFsaWRhdGVCYXNpYyBhbmQgcmV0dXJuIGFueSBub24tbmlsIGVycm9yLgovLyBJZiBWYWxpZGF0ZUJhc2ljIHBhc3NlcywgZGVjb3JhdG9yIGNhbGxzIG5leHQgQW50ZUhhbmRsZXIgaW4gY2hhaW4uIE5vdGUsCi8vIFZhbGlkYXRlQmFzaWNEZWNvcmF0b3IgZGVjb3JhdG9yIHdpbGwgbm90IGdldCBleGVjdXRlZCBvbiBSZUNoZWNrVHggc2luY2UgaXQKLy8gaXMgbm90IGRlcGVuZGVudCBvbiBhcHBsaWNhdGlvbiBzdGF0ZS4KdHlwZSBWYWxpZGF0ZUJhc2ljRGVjb3JhdG9yIHN0cnVjdHt9CgpmdW5jIE5ld1ZhbGlkYXRlQmFzaWNEZWNvcmF0b3IoKSBWYWxpZGF0ZUJhc2ljRGVjb3JhdG9yIHsKCXJldHVybiBWYWxpZGF0ZUJhc2ljRGVjb3JhdG9ye30KfQoKZnVuYyAodmJkIFZhbGlkYXRlQmFzaWNEZWNvcmF0b3IpIEFudGVIYW5kbGUoY3R4IHNkay5Db250ZXh0LCB0eCBzZGsuVHgsIHNpbXVsYXRlIGJvb2wsIG5leHQgc2RrLkFudGVIYW5kbGVyKSAoc2RrLkNvbnRleHQsIGVycm9yKSB7CgkvLyBubyBuZWVkIHRvIHZhbGlkYXRlIGJhc2ljIG9uIHJlY2hlY2sgdHgsIGNhbGwgbmV4dCBhbnRlaGFuZGxlcgoJaWYgY3R4LklzUmVDaGVja1R4KCkgewoJCXJldHVybiBuZXh0KGN0eCwgdHgsIHNpbXVsYXRlKQoJfQoJaWYgZXJyIDo9IHR4LlZhbGlkYXRlQmFzaWMoKTsgZXJyICE9IG5pbCB7CgkJcmV0dXJuIGN0eCwgZXJyCgl9CgoJcmV0dXJuIG5leHQoY3R4LCB0eCwgc2ltdWxhdGUpCn0KCi8vIFR4IG11c3QgaGF2ZSBHZXRNZW1vKCkgbWV0aG9kIHRvIHVzZSBWYWxpZGF0ZU1lbW9EZWNvcmF0b3IKdHlwZSBUeFdpdGhNZW1vIGludGVyZmFjZSB7CglzZGsuVHgKCUdldE1lbW8oKSBzdHJpbmcKfQoKLy8gVmFsaWRhdGVNZW1vRGVjb3JhdG9yIHdpbGwgdmFsaWRhdGUgbWVtbyBnaXZlbiB0aGUgcGFyYW1ldGVycyBwYXNzZWQgaW4KLy8gSWYgbWVtbyBpcyB0b28gbGFyZ2UgZGVjb3JhdG9yIHJldHVybnMgd2l0aCBlcnJvciwgb3RoZXJ3aXNlIGNhbGwgbmV4dCBBbnRlSGFuZGxlcgovLyBDT05UUkFDVDogVHggbXVzdCBpbXBsZW1lbnQgVHhXaXRoTWVtbyBpbnRlcmZhY2UKdHlwZSBWYWxpZGF0ZU1lbW9EZWNvcmF0b3Igc3RydWN0IHsKCWFrIGtlZXBlci5BY2NvdW50S2VlcGVyCn0KCmZ1bmMgTmV3VmFsaWRhdGVNZW1vRGVjb3JhdG9yKGFrIGtlZXBlci5BY2NvdW50S2VlcGVyKSBWYWxpZGF0ZU1lbW9EZWNvcmF0b3IgewoJcmV0dXJuIFZhbGlkYXRlTWVtb0RlY29yYXRvcnsKCQlhazogYWssCgl9Cn0KCmZ1bmMgKHZtZCBWYWxpZGF0ZU1lbW9EZWNvcmF0b3IpIEFudGVIYW5kbGUoY3R4IHNkay5Db250ZXh0LCB0eCBzZGsuVHgsIHNpbXVsYXRlIGJvb2wsIG5leHQgc2RrLkFudGVIYW5kbGVyKSAoc2RrLkNvbnRleHQsIGVycm9yKSB7CgltZW1vVHgsIG9rIDo9IHR4LihUeFdpdGhNZW1vKQoJaWYgIW9rIHsKCQlyZXR1cm4gY3R4LCBzZGtlcnJvcnMuV3JhcChzZGtlcnJvcnMuRXJyVHhEZWNvZGUsICZxdW90O2ludmFsaWQgdHJhbnNhY3Rpb24gdHlwZSZxdW90OykKCX0KCglwYXJhbXMgOj0gdm1kLmFrLkdldFBhcmFtcyhjdHgpCgoJbWVtb0xlbmd0aCA6PSBsZW4obWVtb1R4LkdldE1lbW8oKSkKCWlmIHVpbnQ2NChtZW1vTGVuZ3RoKSAmZ3Q7IHBhcmFtcy5NYXhNZW1vQ2hhcmFjdGVycyB7CgkJcmV0dXJuIGN0eCwgZXJyLldyYXBmKGVyci5FcnJNZW1vVG9vTGFyZ2UsCgkJCSZxdW90O21heGltdW0gbnVtYmVyIG9mIGNoYXJhY3RlcnMgaXMgJWQgYnV0IHJlY2VpdmVkICVkIGNoYXJhY3RlcnMmcXVvdDssCgkJCXBhcmFtcy5NYXhNZW1vQ2hhcmFjdGVycywgbWVtb0xlbmd0aCwKCQkpCgl9CgoJcmV0dXJuIG5leHQoY3R4LCB0eCwgc2ltdWxhdGUpCn0KCi8vIENvbnN1bWVUeFNpemVHYXNEZWNvcmF0b3Igd2lsbCB0YWtlIGluIHBhcmFtZXRlcnMgYW5kIGNvbnN1bWUgZ2FzIHByb3BvcnRpb25hbAovLyB0byB0aGUgc2l6ZSBvZiB0eCBiZWZvcmUgY2FsbGluZyBuZXh0IEFudGVIYW5kbGVyLiBOb3RlLCB0aGUgZ2FzIGNvc3RzIHdpbGwgYmUKLy8gc2xpZ2h0bHkgb3ZlciBlc3RpbWF0ZWQgZHVlIHRvIHRoZSBmYWN0IHRoYXQgYW55IGdpdmVuIHNpZ25pbmcgYWNjb3VudCBtYXkgbmVlZAovLyB0byBiZSByZXRyaWV2ZWQgZnJvbSBzdGF0ZS4KLy8KLy8gQ09OVFJBQ1Q6IElmIHNpbXVsYXRlPXRydWUsIHRoZW4gc2lnbmF0dXJlcyBtdXN0IGVpdGhlciBiZSBjb21wbGV0ZWx5IGZpbGxlZAovLyBpbiBvciBlbXB0eS4KLy8gQ09OVFJBQ1Q6IFRvIHVzZSB0aGlzIGRlY29yYXRvciwgc2lnbmF0dXJlcyBvZiB0cmFuc2FjdGlvbiBtdXN0IGJlIHJlcHJlc2VudGVkCi8vIGFzIHR5cGVzLlN0ZFNpZ25hdHVyZSBvdGhlcndpc2Ugc2ltdWxhdGUgbW9kZSB3aWxsIGluY29ycmVjdGx5IGVzdGltYXRlIGdhcyBjb3N0Lgp0eXBlIENvbnN1bWVUeFNpemVHYXNEZWNvcmF0b3Igc3RydWN0IHsKCWFrIGtlZXBlci5BY2NvdW50S2VlcGVyCn0KCmZ1bmMgTmV3Q29uc3VtZUdhc0ZvclR4U2l6ZURlY29yYXRvcihhayBrZWVwZXIuQWNjb3VudEtlZXBlcikgQ29uc3VtZVR4U2l6ZUdhc0RlY29yYXRvciB7CglyZXR1cm4gQ29uc3VtZVR4U2l6ZUdhc0RlY29yYXRvcnsKCQlhazogYWssCgl9Cn0KCmZ1bmMgKGNndHMgQ29uc3VtZVR4U2l6ZUdhc0RlY29yYXRvcikgQW50ZUhhbmRsZShjdHggc2RrLkNvbnRleHQsIHR4IHNkay5UeCwgc2ltdWxhdGUgYm9vbCwgbmV4dCBzZGsuQW50ZUhhbmRsZXIpIChzZGsuQ29udGV4dCwgZXJyb3IpIHsKCXNpZ1R4LCBvayA6PSB0eC4oU2lnVmVyaWZpYWJsZVR4KQoJaWYgIW9rIHsKCQlyZXR1cm4gY3R4LCBzZGtlcnJvcnMuV3JhcChzZGtlcnJvcnMuRXJyVHhEZWNvZGUsICZxdW90O2ludmFsaWQgdHggdHlwZSZxdW90OykKCX0KCXBhcmFtcyA6PSBjZ3RzLmFrLkdldFBhcmFtcyhjdHgpCgljdHguR2FzTWV0ZXIoKS5Db25zdW1lR2FzKHBhcmFtcy5UeFNpemVDb3N0UGVyQnl0ZSpzZGsuR2FzKGxlbihjdHguVHhCeXRlcygpKSksICZxdW90O3R4U2l6ZSZxdW90OykKCgkvLyBzaW11bGF0ZSBnYXMgY29zdCBmb3Igc2lnbmF0dXJlcyBpbiBzaW11bGF0ZSBtb2RlCglpZiBzaW11bGF0ZSB7CgkJLy8gaW4gc2ltdWxhdGUgbW9kZSwgZWFjaCBlbGVtZW50IHNob3VsZCBiZSBhIG5pbCBzaWduYXR1cmUKCQlzaWdzIDo9IHNpZ1R4LkdldFNpZ25hdHVyZXMoKQoJCWZvciBpLCBzaWduZXIgOj0gcmFuZ2Ugc2lnVHguR2V0U2lnbmVycygpIHsKCQkJLy8gaWYgc2lnbmF0dXJlIGlzIGFscmVhZHkgZmlsbGVkIGluLCBubyBuZWVkIHRvIHNpbXVsYXRlIGdhcyBjb3N0CgkJCWlmIHNpZ3NbaV0gIT0gbmlsIHsKCQkJCWNvbnRpbnVlCgkJCX0KCQkJYWNjIDo9IGNndHMuYWsuR2V0QWNjb3VudChjdHgsIHNpZ25lcikKCgkJCXZhciBwdWJrZXkgY3J5cHRvLlB1YktleQoJCQkvLyB1c2UgcGxhY2Vob2xkZXIgc2ltU2VjcDI1NmsxUHVia2V5IGlmIHNpZyBpcyBuaWwKCQkJaWYgYWNjID09IG5pbCB8fCBhY2MuR2V0UHViS2V5KCkgPT0gbmlsIHsKCQkJCXB1YmtleSA9IHNpbVNlY3AyNTZrMVB1YmtleQoJCQl9IGVsc2UgewoJCQkJcHVia2V5ID0gYWNjLkdldFB1YktleSgpCgkJCX0KCQkJLy8gdXNlIHN0ZHNpZ25hdHVyZSB0byBtb2NrIHRoZSBzaXplIG9mIGEgZnVsbCBzaWduYXR1cmUKCQkJc2ltU2lnIDo9IHR5cGVzLlN0ZFNpZ25hdHVyZXsKCQkJCVNpZ25hdHVyZTogc2ltU2VjcDI1NmsxU2lnWzpdLAoJCQkJUHViS2V5OiAgICBwdWJrZXksCgkJCX0KCQkJc2lnQnogOj0gdHlwZXMuTW9kdWxlQ2RjLk11c3RNYXJzaGFsQmluYXJ5TGVuZ3RoUHJlZml4ZWQoc2ltU2lnKQoJCQljb3N0IDo9IHNkay5HYXMobGVuKHNpZ0J6KSArIDYpCgoJCQkvLyBJZiB0aGUgcHVia2V5IGlzIGEgbXVsdGktc2lnbmF0dXJlIHB1YmtleSwgdGhlbiB3ZSBlc3RpbWF0ZSBmb3IgdGhlIG1heGltdW0KCQkJLy8gbnVtYmVyIG9mIHNpZ25lcnMuCgkJCWlmIF8sIG9rIDo9IHB1YmtleS4obXVsdGlzaWcuUHViS2V5TXVsdGlzaWdUaHJlc2hvbGQpOyBvayB7CgkJCQljb3N0ICo9IHBhcmFtcy5UeFNpZ0xpbWl0CgkJCX0KCgkJCWN0eC5HYXNNZXRlcigpLkNvbnN1bWVHYXMocGFyYW1zLlR4U2l6ZUNvc3RQZXJCeXRlKmNvc3QsICZxdW90O3R4U2l6ZSZxdW90OykKCQl9Cgl9CgoJcmV0dXJuIG5leHQoY3R4LCB0eCwgc2ltdWxhdGUpCn0K"}})],1),e._v(" "),a("li",[a("code",[e._v("Events ([]cmn.KVPair)")]),e._v(": Key-Value tags for filtering and indexing transactions (eg. by account). See "),a("RouterLink",{attrs:{to:"/core/events.html"}},[a("code",[e._v("event")]),e._v("s")]),e._v(" for more.")],1),e._v(" "),a("li",[a("code",[e._v("Codespace (string)")]),e._v(": Namespace for the Code.")])]),e._v(" "),a("h4",{attrs:{id:"rechecktx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rechecktx"}},[e._v("#")]),e._v(" RecheckTx")]),e._v(" "),a("p",[e._v("After "),a("code",[e._v("Commit")]),e._v(", "),a("code",[e._v("CheckTx")]),e._v(" is run again on all transactions that remain in the node's local mempool\nafter filtering those included in the block. To prevent the mempool from rechecking all transactions\nevery time a block is committed, the configuration option "),a("code",[e._v("mempool.recheck=false")]),e._v(" can be set. As of\nTendermint v0.32.1, an additional "),a("code",[e._v("Type")]),e._v(" parameter is made available to the "),a("code",[e._v("CheckTx")]),e._v(" function that\nindicates whether an incoming transaction is new ("),a("code",[e._v("CheckTxType_New")]),e._v("), or a recheck ("),a("code",[e._v("CheckTxType_Recheck")]),e._v(").\nThis allows certain checks like signature verification can be skipped during "),a("code",[e._v("CheckTxType_Recheck")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"delivertx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#delivertx"}},[e._v("#")]),e._v(" DeliverTx")]),e._v(" "),a("p",[e._v("When the underlying consensus engine receives a block proposal, each transaction in the block needs to be processed by the application. To that end, the underlying consensus engine sends a "),a("code",[e._v("DeliverTx")]),e._v(" message to the application for each transaction in a sequential order.")]),e._v(" "),a("p",[e._v("Before the first transaction of a given block is processed, a "),a("a",{attrs:{href:"#volatile-states"}},[e._v("volatile state")]),e._v(" called "),a("code",[e._v("deliverState")]),e._v(" is intialized during "),a("a",{attrs:{href:"#beginblock"}},[a("code",[e._v("BeginBlock")])]),e._v(". This state is updated each time a transaction is processed via "),a("code",[e._v("DeliverTx")]),e._v(", and committed to the "),a("a",{attrs:{href:"#main-state"}},[e._v("main state")]),e._v(" when the block is "),a("a",{attrs:{href:"#commit"}},[e._v("committed")]),e._v(", after what is is set to "),a("code",[e._v("nil")]),e._v(".")]),e._v(" "),a("p",[a("code",[e._v("DeliverTx")]),e._v(" performs the "),a("strong",[e._v("exact same steps as "),a("code",[e._v("CheckTx")])]),e._v(", with a little caveat at step 3 and the addition of a fifth step:")]),e._v(" "),a("ol",[a("li",[e._v("The "),a("code",[e._v("AnteHandler")]),e._v(" does "),a("strong",[e._v("not")]),e._v(" check that the transaction's "),a("code",[e._v("gas-prices")]),e._v(" is sufficient. That is because the "),a("code",[e._v("min-gas-prices")]),e._v(" value "),a("code",[e._v("gas-prices")]),e._v(" is checked against is local to the node, and therefore what is enough for one full-node might not be for another. This means that the proposer can potentially include transactions for free, although they are not incentivised to do so, as they earn a bonus on the total fee of the block they propose.")]),e._v(" "),a("li",[e._v("For each "),a("code",[e._v("message")]),e._v(" in the transaction, route to the appropriate module's "),a("RouterLink",{attrs:{to:"/building-modules/handler.html"}},[a("code",[e._v("handler")])]),e._v(". Additional "),a("em",[e._v("stateful")]),e._v(" checks are performed, and the cache-wrapped multistore held in "),a("code",[e._v("deliverState")]),e._v("'s "),a("code",[e._v("context")]),e._v(" is updated by the module's "),a("code",[e._v("keeper")]),e._v(". If the "),a("code",[e._v("handler")]),e._v(" returns successfully, the cache-wrapped multistore held in "),a("code",[e._v("context")]),e._v(" is written to "),a("code",[e._v("deliverState")]),e._v(" "),a("code",[e._v("CacheMultiStore")]),e._v(".")],1)]),e._v(" "),a("p",[e._v("During step 5., each read/write to the store increases the value of "),a("code",[e._v("GasConsumed")]),e._v(". You can find the default cost of each operation:")]),e._v(" "),a("p",[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBHYXNDb25maWcgc3RydWN0IHsKCUhhc0Nvc3QgICAgICAgICAgR2FzCglEZWxldGVDb3N0ICAgICAgIEdhcwoJUmVhZENvc3RGbGF0ICAgICBHYXMKCVJlYWRDb3N0UGVyQnl0ZSAgR2FzCglXcml0ZUNvc3RGbGF0ICAgIEdhcwoJV3JpdGVDb3N0UGVyQnl0ZSBHYXMKCUl0ZXJOZXh0Q29zdEZsYXQgR2FzCn0="}})],1),e._v(" "),a("p",[e._v("At any point, if "),a("code",[e._v("GasConsumed > GasWanted")]),e._v(", the function returns with "),a("code",[e._v("Code != 0")]),e._v(" and "),a("code",[e._v("DeliverTx")]),e._v(" fails.")]),e._v(" "),a("p",[a("code",[e._v("DeliverTx")]),e._v(" returns a response to the underlying consensus engine of type "),a("a",{attrs:{href:"https://tendermint.com/docs/spec/abci/abci.html#delivertx",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("abci.ResponseDeliverTx")]),a("OutboundLink")],1),e._v(". The response contains:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("Code (uint32)")]),e._v(": Response Code. "),a("code",[e._v("0")]),e._v(" if successful.")]),e._v(" "),a("li",[a("code",[e._v("Data ([]byte)")]),e._v(": Result bytes, if any.")]),e._v(" "),a("li",[a("code",[e._v("Log (string):")]),e._v(" The output of the application's logger. May be non-deterministic.")]),e._v(" "),a("li",[a("code",[e._v("Info (string):")]),e._v(" Additional information. May be non-deterministic.")]),e._v(" "),a("li",[a("code",[e._v("GasWanted (int64)")]),e._v(": Amount of gas requested for transaction. It is provided by users when they generate the transaction.")]),e._v(" "),a("li",[a("code",[e._v("GasUsed (int64)")]),e._v(": Amount of gas consumed by transaction. During "),a("code",[e._v("DeliverTx")]),e._v(", this value is computed by multiplying the standard cost of a transaction byte by the size of the raw transaction, and by adding gas each time a read/write to the store occurs.")]),e._v(" "),a("li",[a("code",[e._v("Events ([]cmn.KVPair)")]),e._v(": Key-Value tags for filtering and indexing transactions (eg. by account). See "),a("RouterLink",{attrs:{to:"/core/events.html"}},[a("code",[e._v("event")]),e._v("s")]),e._v(" for more.")],1),e._v(" "),a("li",[a("code",[e._v("Codespace (string)")]),e._v(": Namespace for the Code.")])]),e._v(" "),a("h2",{attrs:{id:"runtx-antehandler-and-runmsgs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runtx-antehandler-and-runmsgs"}},[e._v("#")]),e._v(" RunTx, AnteHandler and RunMsgs")]),e._v(" "),a("h3",{attrs:{id:"runtx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runtx"}},[e._v("#")]),e._v(" RunTx")]),e._v(" "),a("p",[a("code",[e._v("RunTx")]),e._v(" is called from "),a("code",[e._v("CheckTx")]),e._v("/"),a("code",[e._v("DeliverTx")]),e._v(" to handle the transaction, with "),a("code",[e._v("runTxModeCheck")]),e._v(" or "),a("code",[e._v("runTxModeDeliver")]),e._v(" as parameter to differentiate between the two modes of execution. Note that when "),a("code",[e._v("RunTx")]),e._v(" receives a transaction, it has already been decoded.")]),e._v(" "),a("p",[e._v("The first thing "),a("code",[e._v("RunTx")]),e._v(" does upon being called is to retrieve the "),a("code",[e._v("context")]),e._v("'s "),a("code",[e._v("CacheMultiStore")]),e._v(" by calling the "),a("code",[e._v("getContextForTx()")]),e._v(" function with the appropriate mode (either "),a("code",[e._v("runTxModeCheck")]),e._v(" or "),a("code",[e._v("runTxModeDeliver")]),e._v("). This "),a("code",[e._v("CacheMultiStore")]),e._v(" is a cached version of the main store instantiated during "),a("code",[e._v("BeginBlock")]),e._v(" for "),a("code",[e._v("DeliverTx")]),e._v(" and during the "),a("code",[e._v("Commit")]),e._v(" of the previous block for "),a("code",[e._v("CheckTx")]),e._v(".  After that, two "),a("code",[e._v("defer func()")]),e._v(" are called for "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html"}},[a("code",[e._v("gas")])]),e._v(" management. They are executed when "),a("code",[e._v("runTx")]),e._v(" returns and make sure "),a("code",[e._v("gas")]),e._v(" is actually consumed, and will throw errors, if any.")],1),e._v(" "),a("p",[e._v("After that, "),a("code",[e._v("RunTx()")]),e._v(" calls "),a("code",[e._v("ValidateBasic()")]),e._v(" on each "),a("code",[e._v("message")]),e._v("in the "),a("code",[e._v("Tx")]),e._v(", which runs preliminary "),a("em",[e._v("stateless")]),e._v(" validity checks. If any "),a("code",[e._v("message")]),e._v(" fails to pass "),a("code",[e._v("ValidateBasic()")]),e._v(", "),a("code",[e._v("RunTx()")]),e._v(" returns with an error.")]),e._v(" "),a("p",[e._v("Then, the "),a("a",{attrs:{href:"#antehandler"}},[a("code",[e._v("anteHandler")])]),e._v(" of the application is run (if it exists). In preparation of this step, both the "),a("code",[e._v("checkState")]),e._v("/"),a("code",[e._v("deliverState")]),e._v("'s "),a("code",[e._v("context")]),e._v(" and "),a("code",[e._v("context")]),e._v("'s "),a("code",[e._v("CacheMultiStore")]),e._v(" are cached-wrapped using the "),a("code",[e._v("cacheTxContext()")]),e._v(" function.")]),e._v(" "),a("p",[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBiYXNlYXBwCgppbXBvcnQgKAoJJnF1b3Q7ZW5jb2RpbmcvanNvbiZxdW90OwoJJnF1b3Q7ZXJyb3JzJnF1b3Q7CgkmcXVvdDtmbXQmcXVvdDsKCSZxdW90O2lvL2lvdXRpbCZxdW90OwoJJnF1b3Q7b3MmcXVvdDsKCSZxdW90O3JlZmxlY3QmcXVvdDsKCSZxdW90O3J1bnRpbWUvZGVidWcmcXVvdDsKCSZxdW90O3N0cmluZ3MmcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL2dvZ28vcHJvdG9idWYvcHJvdG8mcXVvdDsKCWFiY2kgJnF1b3Q7Z2l0aHViLmNvbS90ZW5kZXJtaW50L3RlbmRlcm1pbnQvYWJjaS90eXBlcyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS90ZW5kZXJtaW50L3RlbmRlcm1pbnQvY3J5cHRvL3RtaGFzaCZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS90ZW5kZXJtaW50L3RlbmRlcm1pbnQvbGlicy9sb2cmcXVvdDsKCWRibSAmcXVvdDtnaXRodWIuY29tL3RlbmRlcm1pbnQvdG0tZGImcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3N0b3JlJnF1b3Q7CglzdG9yZXR5cGVzICZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvc3RvcmUvdHlwZXMmcXVvdDsKCXNkayAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3R5cGVzJnF1b3Q7CikKCmNvbnN0ICgKCXJ1blR4TW9kZUNoZWNrICAgIHJ1blR4TW9kZSA9IGlvdGEgLy8gQ2hlY2sgYSB0cmFuc2FjdGlvbgoJcnVuVHhNb2RlUmVDaGVjayAgICAgICAgICAgICAgICAgICAvLyBSZWNoZWNrIGEgKHBlbmRpbmcpIHRyYW5zYWN0aW9uIGFmdGVyIGEgY29tbWl0CglydW5UeE1vZGVTaW11bGF0ZSAgICAgICAgICAgICAgICAgIC8vIFNpbXVsYXRlIGEgdHJhbnNhY3Rpb24KCXJ1blR4TW9kZURlbGl2ZXIgICAgICAgICAgICAgICAgICAgLy8gRGVsaXZlciBhIHRyYW5zYWN0aW9uCgoJLy8gTWFpblN0b3JlS2V5IGlzIHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG1haW4gc3RvcmUKCU1haW5TdG9yZUtleSA9ICZxdW90O21haW4mcXVvdDsKKQoKdmFyICgKCV8gYWJjaS5BcHBsaWNhdGlvbiA9ICgqQmFzZUFwcCkobmlsKQoKCS8vIG1haW5Db25zZW5zdXNQYXJhbXNLZXkgZGVmaW5lcyBhIGtleSB0byBzdG9yZSB0aGUgY29uc2Vuc3VzIHBhcmFtcyBpbiB0aGUKCS8vIG1haW4gc3RvcmUuCgltYWluQ29uc2Vuc3VzUGFyYW1zS2V5ID0gW11ieXRlKCZxdW90O2NvbnNlbnN1c19wYXJhbXMmcXVvdDspCikKCnR5cGUgKAoJLy8gRW51bSBtb2RlIGZvciBhcHAucnVuVHgKCXJ1blR4TW9kZSB1aW50OAoKCS8vIFN0b3JlTG9hZGVyIGRlZmluZXMgYSBjdXN0b21pemFibGUgZnVuY3Rpb24gdG8gY29udHJvbCBob3cgd2UgbG9hZCB0aGUgQ29tbWl0TXVsdGlTdG9yZQoJLy8gZnJvbSBkaXNrLiBUaGlzIGlzIHVzZWZ1bCBmb3Igc3RhdGUgbWlncmF0aW9uLCB3aGVuIGxvYWRpbmcgYSBkYXRhc3RvcmUgd3JpdHRlbiB3aXRoCgkvLyBhbiBvbGRlciB2ZXJzaW9uIG9mIHRoZSBzb2Z0d2FyZS4gSW4gcGFydGljdWxhciwgaWYgYSBtb2R1bGUgY2hhbmdlZCB0aGUgc3Vic3RvcmUga2V5IG5hbWUKCS8vIChvciByZW1vdmVkIGEgc3Vic3RvcmUpIGJldHdlZW4gdHdvIHZlcnNpb25zIG9mIHRoZSBzb2Z0d2FyZS4KCVN0b3JlTG9hZGVyIGZ1bmMobXMgc2RrLkNvbW1pdE11bHRpU3RvcmUpIGVycm9yCikKCi8vIEJhc2VBcHAgcmVmbGVjdHMgdGhlIEFCQ0kgYXBwbGljYXRpb24gaW1wbGVtZW50YXRpb24uCnR5cGUgQmFzZUFwcCBzdHJ1Y3QgeyAvLyBub2xpbnQ6IG1hbGlnbmVkCgkvLyBpbml0aWFsaXplZCBvbiBjcmVhdGlvbgoJbG9nZ2VyICAgICAgbG9nLkxvZ2dlcgoJbmFtZSAgICAgICAgc3RyaW5nICAgICAgICAgICAgICAgLy8gYXBwbGljYXRpb24gbmFtZSBmcm9tIGFiY2kuSW5mbwoJZGIgICAgICAgICAgZGJtLkRCICAgICAgICAgICAgICAgLy8gY29tbW9uIERCIGJhY2tlbmQKCWNtcyAgICAgICAgIHNkay5Db21taXRNdWx0aVN0b3JlIC8vIE1haW4gKHVuY2FjaGVkKSBzdGF0ZQoJc3RvcmVMb2FkZXIgU3RvcmVMb2FkZXIgICAgICAgICAgLy8gZnVuY3Rpb24gdG8gaGFuZGxlIHN0b3JlIGxvYWRpbmcsIG1heSBiZSBvdmVycmlkZGVuIHdpdGggU2V0U3RvcmVMb2FkZXIoKQoJcm91dGVyICAgICAgc2RrLlJvdXRlciAgICAgICAgICAgLy8gaGFuZGxlIGFueSBraW5kIG9mIG1lc3NhZ2UKCXF1ZXJ5Um91dGVyIHNkay5RdWVyeVJvdXRlciAgICAgIC8vIHJvdXRlciBmb3IgcmVkaXJlY3RpbmcgcXVlcnkgY2FsbHMKCXR4RGVjb2RlciAgIHNkay5UeERlY29kZXIgICAgICAgIC8vIHVubWFyc2hhbCBbXWJ5dGUgaW50byBzZGsuVHgKCgkvLyBzZXQgdXBvbiBMb2FkVmVyc2lvbiBvciBMb2FkTGF0ZXN0VmVyc2lvbi4KCWJhc2VLZXkgKnNkay5LVlN0b3JlS2V5IC8vIE1haW4gS1ZTdG9yZSBpbiBjbXMKCglhbnRlSGFuZGxlciAgICBzZGsuQW50ZUhhbmRsZXIgIC8vIGFudGUgaGFuZGxlciBmb3IgZmVlIGFuZCBhdXRoCglpbml0Q2hhaW5lciAgICBzZGsuSW5pdENoYWluZXIgIC8vIGluaXRpYWxpemUgc3RhdGUgd2l0aCB2YWxpZGF0b3JzIGFuZCBzdGF0ZSBibG9iCgliZWdpbkJsb2NrZXIgICBzZGsuQmVnaW5CbG9ja2VyIC8vIGxvZ2ljIHRvIHJ1biBiZWZvcmUgYW55IHR4cwoJZW5kQmxvY2tlciAgICAgc2RrLkVuZEJsb2NrZXIgICAvLyBsb2dpYyB0byBydW4gYWZ0ZXIgYWxsIHR4cywgYW5kIHRvIGRldGVybWluZSB2YWxzZXQgY2hhbmdlcwoJYWRkclBlZXJGaWx0ZXIgc2RrLlBlZXJGaWx0ZXIgICAvLyBmaWx0ZXIgcGVlcnMgYnkgYWRkcmVzcyBhbmQgcG9ydAoJaWRQZWVyRmlsdGVyICAgc2RrLlBlZXJGaWx0ZXIgICAvLyBmaWx0ZXIgcGVlcnMgYnkgbm9kZSBJRAoJZmF1eE1lcmtsZU1vZGUgYm9vbCAgICAgICAgICAgICAvLyBpZiB0cnVlLCBJQVZMIE1vdW50U3RvcmVzIHVzZXMgTW91bnRTdG9yZXNEQiBmb3Igc2ltdWxhdGlvbiBzcGVlZC4KCgkvLyB2b2xhdGlsZSBzdGF0ZXM6CgkvLwoJLy8gY2hlY2tTdGF0ZSBpcyBzZXQgb24gSW5pdENoYWluIGFuZCByZXNldCBvbiBDb21taXQKCS8vIGRlbGl2ZXJTdGF0ZSBpcyBzZXQgb24gSW5pdENoYWluIGFuZCBCZWdpbkJsb2NrIGFuZCBzZXQgdG8gbmlsIG9uIENvbW1pdAoJY2hlY2tTdGF0ZSAgICpzdGF0ZSAvLyBmb3IgQ2hlY2tUeAoJZGVsaXZlclN0YXRlICpzdGF0ZSAvLyBmb3IgRGVsaXZlclR4CgoJLy8gYW4gaW50ZXItYmxvY2sgd3JpdGUtdGhyb3VnaCBjYWNoZSBwcm92aWRlZCB0byB0aGUgY29udGV4dCBkdXJpbmcgZGVsaXZlclN0YXRlCglpbnRlckJsb2NrQ2FjaGUgc2RrLk11bHRpU3RvcmVQZXJzaXN0ZW50Q2FjaGUKCgkvLyBhYnNlbnQgdmFsaWRhdG9ycyBmcm9tIGJlZ2luIGJsb2NrCgl2b3RlSW5mb3MgW11hYmNpLlZvdGVJbmZvCgoJLy8gY29uc2Vuc3VzIHBhcmFtcwoJLy8gVE9ETzogTW92ZSB0aGlzIGluIHRoZSBmdXR1cmUgdG8gYmFzZWFwcCBwYXJhbSBzdG9yZSBvbiBtYWluIHN0b3JlLgoJY29uc2Vuc3VzUGFyYW1zICphYmNpLkNvbnNlbnN1c1BhcmFtcwoKCS8vIFRoZSBtaW5pbXVtIGdhcyBwcmljZXMgYSB2YWxpZGF0b3IgaXMgd2lsbGluZyB0byBhY2NlcHQgZm9yIHByb2Nlc3NpbmcgYQoJLy8gdHJhbnNhY3Rpb24uIFRoaXMgaXMgbWFpbmx5IHVzZWQgZm9yIERvUyBhbmQgc3BhbSBwcmV2ZW50aW9uLgoJbWluR2FzUHJpY2VzIHNkay5EZWNDb2lucwoKCS8vIGZsYWcgZm9yIHNlYWxpbmcgb3B0aW9ucyBhbmQgcGFyYW1ldGVycyB0byBhIEJhc2VBcHAKCXNlYWxlZCBib29sCgoJLy8gYmxvY2sgaGVpZ2h0IGF0IHdoaWNoIHRvIGhhbHQgdGhlIGNoYWluIGFuZCBncmFjZWZ1bGx5IHNodXRkb3duCgloYWx0SGVpZ2h0IHVpbnQ2NAoKCS8vIG1pbmltdW0gYmxvY2sgdGltZSAoaW4gVW5peCBzZWNvbmRzKSBhdCB3aGljaCB0byBoYWx0IHRoZSBjaGFpbiBhbmQgZ3JhY2VmdWxseSBzaHV0ZG93bgoJaGFsdFRpbWUgdWludDY0CgoJLy8gYXBwbGljYXRpb24ncyB2ZXJzaW9uIHN0cmluZwoJYXBwVmVyc2lvbiBzdHJpbmcKfQoKLy8gTmV3QmFzZUFwcCByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIGFuIGluaXRpYWxpemVkIEJhc2VBcHAuIEl0IGFjY2VwdHMgYQovLyB2YXJpYWRpYyBudW1iZXIgb2Ygb3B0aW9uIGZ1bmN0aW9ucywgd2hpY2ggYWN0IG9uIHRoZSBCYXNlQXBwIHRvIHNldAovLyBjb25maWd1cmF0aW9uIGNob2ljZXMuCi8vCi8vIE5PVEU6IFRoZSBkYiBpcyB1c2VkIHRvIHN0b3JlIHRoZSB2ZXJzaW9uIG51bWJlciBmb3Igbm93LgpmdW5jIE5ld0Jhc2VBcHAoCgluYW1lIHN0cmluZywgbG9nZ2VyIGxvZy5Mb2dnZXIsIGRiIGRibS5EQiwgdHhEZWNvZGVyIHNkay5UeERlY29kZXIsIG9wdGlvbnMgLi4uZnVuYygqQmFzZUFwcCksCikgKkJhc2VBcHAgewoKCWFwcCA6PSAmYW1wO0Jhc2VBcHB7CgkJbG9nZ2VyOiAgICAgICAgIGxvZ2dlciwKCQluYW1lOiAgICAgICAgICAgbmFtZSwKCQlkYjogICAgICAgICAgICAgZGIsCgkJY21zOiAgICAgICAgICAgIHN0b3JlLk5ld0NvbW1pdE11bHRpU3RvcmUoZGIpLAoJCXN0b3JlTG9hZGVyOiAgICBEZWZhdWx0U3RvcmVMb2FkZXIsCgkJcm91dGVyOiAgICAgICAgIE5ld1JvdXRlcigpLAoJCXF1ZXJ5Um91dGVyOiAgICBOZXdRdWVyeVJvdXRlcigpLAoJCXR4RGVjb2RlcjogICAgICB0eERlY29kZXIsCgkJZmF1eE1lcmtsZU1vZGU6IGZhbHNlLAoJfQoJZm9yIF8sIG9wdGlvbiA6PSByYW5nZSBvcHRpb25zIHsKCQlvcHRpb24oYXBwKQoJfQoKCWlmIGFwcC5pbnRlckJsb2NrQ2FjaGUgIT0gbmlsIHsKCQlhcHAuY21zLlNldEludGVyQmxvY2tDYWNoZShhcHAuaW50ZXJCbG9ja0NhY2hlKQoJfQoKCXJldHVybiBhcHAKfQoKLy8gTmFtZSByZXR1cm5zIHRoZSBuYW1lIG9mIHRoZSBCYXNlQXBwLgpmdW5jIChhcHAgKkJhc2VBcHApIE5hbWUoKSBzdHJpbmcgewoJcmV0dXJuIGFwcC5uYW1lCn0KCi8vIEFwcFZlcnNpb24gcmV0dXJucyB0aGUgYXBwbGljYXRpb24ncyB2ZXJzaW9uIHN0cmluZy4KZnVuYyAoYXBwICpCYXNlQXBwKSBBcHBWZXJzaW9uKCkgc3RyaW5nIHsKCXJldHVybiBhcHAuYXBwVmVyc2lvbgp9CgovLyBMb2dnZXIgcmV0dXJucyB0aGUgbG9nZ2VyIG9mIHRoZSBCYXNlQXBwLgpmdW5jIChhcHAgKkJhc2VBcHApIExvZ2dlcigpIGxvZy5Mb2dnZXIgewoJcmV0dXJuIGFwcC5sb2dnZXIKfQoKLy8gTW91bnRTdG9yZXMgbW91bnRzIGFsbCBJQVZMIG9yIERCIHN0b3JlcyB0byB0aGUgcHJvdmlkZWQga2V5cyBpbiB0aGUgQmFzZUFwcAovLyBtdWx0aXN0b3JlLgpmdW5jIChhcHAgKkJhc2VBcHApIE1vdW50U3RvcmVzKGtleXMgLi4uc2RrLlN0b3JlS2V5KSB7Cglmb3IgXywga2V5IDo9IHJhbmdlIGtleXMgewoJCXN3aXRjaCBrZXkuKHR5cGUpIHsKCQljYXNlICpzZGsuS1ZTdG9yZUtleToKCQkJaWYgIWFwcC5mYXV4TWVya2xlTW9kZSB7CgkJCQlhcHAuTW91bnRTdG9yZShrZXksIHNkay5TdG9yZVR5cGVJQVZMKQoJCQl9IGVsc2UgewoJCQkJLy8gU3RvcmVUeXBlREIgZG9lc24ndCBkbyBhbnl0aGluZyB1cG9uIGNvbW1pdCwgYW5kIGl0IGRvZXNuJ3QKCQkJCS8vIHJldGFpbiBoaXN0b3J5LCBidXQgaXQncyB1c2VmdWwgZm9yIGZhc3RlciBzaW11bGF0aW9uLgoJCQkJYXBwLk1vdW50U3RvcmUoa2V5LCBzZGsuU3RvcmVUeXBlREIpCgkJCX0KCgkJY2FzZSAqc2RrLlRyYW5zaWVudFN0b3JlS2V5OgoJCQlhcHAuTW91bnRTdG9yZShrZXksIHNkay5TdG9yZVR5cGVUcmFuc2llbnQpCgoJCWRlZmF1bHQ6CgkJCXBhbmljKCZxdW90O1VucmVjb2duaXplZCBzdG9yZSBrZXkgdHlwZSAmcXVvdDsgKyByZWZsZWN0LlR5cGVPZihrZXkpLk5hbWUoKSkKCQl9Cgl9Cn0KCi8vIE1vdW50U3RvcmVzIG1vdW50cyBhbGwgSUFWTCBvciBEQiBzdG9yZXMgdG8gdGhlIHByb3ZpZGVkIGtleXMgaW4gdGhlIEJhc2VBcHAKLy8gbXVsdGlzdG9yZS4KZnVuYyAoYXBwICpCYXNlQXBwKSBNb3VudEtWU3RvcmVzKGtleXMgbWFwW3N0cmluZ10qc2RrLktWU3RvcmVLZXkpIHsKCWZvciBfLCBrZXkgOj0gcmFuZ2Uga2V5cyB7CgkJaWYgIWFwcC5mYXV4TWVya2xlTW9kZSB7CgkJCWFwcC5Nb3VudFN0b3JlKGtleSwgc2RrLlN0b3JlVHlwZUlBVkwpCgkJfSBlbHNlIHsKCQkJLy8gU3RvcmVUeXBlREIgZG9lc24ndCBkbyBhbnl0aGluZyB1cG9uIGNvbW1pdCwgYW5kIGl0IGRvZXNuJ3QKCQkJLy8gcmV0YWluIGhpc3RvcnksIGJ1dCBpdCdzIHVzZWZ1bCBmb3IgZmFzdGVyIHNpbXVsYXRpb24uCgkJCWFwcC5Nb3VudFN0b3JlKGtleSwgc2RrLlN0b3JlVHlwZURCKQoJCX0KCX0KfQoKLy8gTW91bnRTdG9yZXMgbW91bnRzIGFsbCBJQVZMIG9yIERCIHN0b3JlcyB0byB0aGUgcHJvdmlkZWQga2V5cyBpbiB0aGUgQmFzZUFwcAovLyBtdWx0aXN0b3JlLgpmdW5jIChhcHAgKkJhc2VBcHApIE1vdW50VHJhbnNpZW50U3RvcmVzKGtleXMgbWFwW3N0cmluZ10qc2RrLlRyYW5zaWVudFN0b3JlS2V5KSB7Cglmb3IgXywga2V5IDo9IHJhbmdlIGtleXMgewoJCWFwcC5Nb3VudFN0b3JlKGtleSwgc2RrLlN0b3JlVHlwZVRyYW5zaWVudCkKCX0KfQoKLy8gTW91bnRTdG9yZVdpdGhEQiBtb3VudHMgYSBzdG9yZSB0byB0aGUgcHJvdmlkZWQga2V5IGluIHRoZSBCYXNlQXBwCi8vIG11bHRpc3RvcmUsIHVzaW5nIGEgc3BlY2lmaWVkIERCLgpmdW5jIChhcHAgKkJhc2VBcHApIE1vdW50U3RvcmVXaXRoREIoa2V5IHNkay5TdG9yZUtleSwgdHlwIHNkay5TdG9yZVR5cGUsIGRiIGRibS5EQikgewoJYXBwLmNtcy5Nb3VudFN0b3JlV2l0aERCKGtleSwgdHlwLCBkYikKfQoKLy8gTW91bnRTdG9yZSBtb3VudHMgYSBzdG9yZSB0byB0aGUgcHJvdmlkZWQga2V5IGluIHRoZSBCYXNlQXBwIG11bHRpc3RvcmUsCi8vIHVzaW5nIHRoZSBkZWZhdWx0IERCLgpmdW5jIChhcHAgKkJhc2VBcHApIE1vdW50U3RvcmUoa2V5IHNkay5TdG9yZUtleSwgdHlwIHNkay5TdG9yZVR5cGUpIHsKCWFwcC5jbXMuTW91bnRTdG9yZVdpdGhEQihrZXksIHR5cCwgbmlsKQp9CgovLyBMb2FkTGF0ZXN0VmVyc2lvbiBsb2FkcyB0aGUgbGF0ZXN0IGFwcGxpY2F0aW9uIHZlcnNpb24uIEl0IHdpbGwgcGFuaWMgaWYKLy8gY2FsbGVkIG1vcmUgdGhhbiBvbmNlIG9uIGEgcnVubmluZyBCYXNlQXBwLgpmdW5jIChhcHAgKkJhc2VBcHApIExvYWRMYXRlc3RWZXJzaW9uKGJhc2VLZXkgKnNkay5LVlN0b3JlS2V5KSBlcnJvciB7CgllcnIgOj0gYXBwLnN0b3JlTG9hZGVyKGFwcC5jbXMpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gZXJyCgl9CglyZXR1cm4gYXBwLmluaXRGcm9tTWFpblN0b3JlKGJhc2VLZXkpCn0KCi8vIERlZmF1bHRTdG9yZUxvYWRlciB3aWxsIGJlIHVzZWQgYnkgZGVmYXVsdCBhbmQgbG9hZHMgdGhlIGxhdGVzdCB2ZXJzaW9uCmZ1bmMgRGVmYXVsdFN0b3JlTG9hZGVyKG1zIHNkay5Db21taXRNdWx0aVN0b3JlKSBlcnJvciB7CglyZXR1cm4gbXMuTG9hZExhdGVzdFZlcnNpb24oKQp9CgovLyBTdG9yZUxvYWRlcldpdGhVcGdyYWRlIGlzIHVzZWQgdG8gcHJlcGFyZSBiYXNlYXBwIHdpdGggYSBmaXhlZCBTdG9yZUxvYWRlcgovLyBwYXR0ZXJuLiBUaGlzIGlzIHVzZWZ1bCBpbiB0ZXN0IGNhc2VzLCBvciB3aXRoIGN1c3RvbSB1cGdyYWRlIGxvYWRpbmcgbG9naWMuCmZ1bmMgU3RvcmVMb2FkZXJXaXRoVXBncmFkZSh1cGdyYWRlcyAqc3RvcmV0eXBlcy5TdG9yZVVwZ3JhZGVzKSBTdG9yZUxvYWRlciB7CglyZXR1cm4gZnVuYyhtcyBzZGsuQ29tbWl0TXVsdGlTdG9yZSkgZXJyb3IgewoJCXJldHVybiBtcy5Mb2FkTGF0ZXN0VmVyc2lvbkFuZFVwZ3JhZGUodXBncmFkZXMpCgl9Cn0KCi8vIFVwZ3JhZGVhYmxlU3RvcmVMb2FkZXIgY2FuIGJlIGNvbmZpZ3VyZWQgYnkgU2V0U3RvcmVMb2FkZXIoKSB0byBjaGVjayBmb3IgdGhlCi8vIGV4aXN0ZW5jZSBvZiBhIGdpdmVuIHVwZ3JhZGUgZmlsZSAtIGpzb24gZW5jb2RlZCBTdG9yZVVwZ3JhZGVzIGRhdGEuCi8vCi8vIElmIG5vdCBmaWxlIGlzIHByZXNlbnQsIGl0IHdpbGwgcGVmb3JtIHRoZSBkZWZhdWx0IGxvYWQgKG5vIHVwZ3JhZGVzIHRvIHN0b3JlKS4KLy8KLy8gSWYgdGhlIGZpbGUgaXMgcHJlc2VudCwgaXQgd2lsbCBwYXJzZSB0aGUgZmlsZSBhbmQgZXhlY3V0ZSB0aG9zZSB1cGdyYWRlcwovLyAocmVuYW1lIG9yIGRlbGV0ZSBzdG9yZXMpLCB3aGlsZSBsb2FkaW5nIHRoZSBkYXRhLiBJdCB3aWxsIGFsc28gZGVsZXRlIHRoZQovLyB1cGdyYWRlIGZpbGUgdXBvbiBzdWNjZXNzZnVsIGxvYWQsIHNvIHRoYXQgdGhlIHVwZ3JhZGUgaXMgb25seSBhcHBsaWVkIG9uY2UsCi8vIGFuZCBub3QgcmUtYXBwbGllZCBvbiBuZXh0IHJlc3RhcnQKLy8KLy8gVGhpcyBpcyB1c2VmdWwgZm9yIGluIHBsYWNlIG1pZ3JhdGlvbnMgd2hlbiBhIHN0b3JlIGtleSBpcyByZW5hbWVkIGJldHdlZW4KLy8gdHdvIHZlcnNpb25zIG9mIHRoZSBzb2Z0d2FyZS4gKFRPRE86IHRoaXMgY29kZSB3aWxsIG1vdmUgdG8geC91cGdyYWRlcwovLyB3aGVuIFBSICM0MjMzIGlzIG1lcmdlZCwgaGVyZSBtYWlubHkgdG8gaGVscCB0ZXN0IHRoZSBkZXNpZ24pCmZ1bmMgVXBncmFkZWFibGVTdG9yZUxvYWRlcih1cGdyYWRlSW5mb1BhdGggc3RyaW5nKSBTdG9yZUxvYWRlciB7CglyZXR1cm4gZnVuYyhtcyBzZGsuQ29tbWl0TXVsdGlTdG9yZSkgZXJyb3IgewoJCV8sIGVyciA6PSBvcy5TdGF0KHVwZ3JhZGVJbmZvUGF0aCkKCQlpZiBvcy5Jc05vdEV4aXN0KGVycikgewoJCQlyZXR1cm4gRGVmYXVsdFN0b3JlTG9hZGVyKG1zKQoJCX0gZWxzZSBpZiBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuIGVycgoJCX0KCgkJLy8gdGhlcmUgaXMgYSBtaWdyYXRpb24gZmlsZSwgbGV0J3MgZXhlY3V0ZQoJCWRhdGEsIGVyciA6PSBpb3V0aWwuUmVhZEZpbGUodXBncmFkZUluZm9QYXRoKQoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXR1cm4gZm10LkVycm9yZigmcXVvdDtjYW5ub3QgcmVhZCB1cGdyYWRlIGZpbGUgJXM6ICV2JnF1b3Q7LCB1cGdyYWRlSW5mb1BhdGgsIGVycikKCQl9CgoJCXZhciB1cGdyYWRlcyBzdG9yZXR5cGVzLlN0b3JlVXBncmFkZXMKCQllcnIgPSBqc29uLlVubWFyc2hhbChkYXRhLCAmYW1wO3VwZ3JhZGVzKQoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXR1cm4gZm10LkVycm9yZigmcXVvdDtjYW5ub3QgcGFyc2UgdXBncmFkZSBmaWxlOiAldiZxdW90OywgZXJyKQoJCX0KCgkJZXJyID0gbXMuTG9hZExhdGVzdFZlcnNpb25BbmRVcGdyYWRlKCZhbXA7dXBncmFkZXMpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybiBmbXQuRXJyb3JmKCZxdW90O2xvYWQgYW5kIHVwZ3JhZGUgZGF0YWJhc2U6ICV2JnF1b3Q7LCBlcnIpCgkJfQoKCQkvLyBpZiB3ZSBoYXZlIGEgc3VjY2Vzc2Z1bCBsb2FkLCB3ZSBkZWxldGUgdGhlIGZpbGUKCQllcnIgPSBvcy5SZW1vdmUodXBncmFkZUluZm9QYXRoKQoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXR1cm4gZm10LkVycm9yZigmcXVvdDtkZWxldGluZyB1cGdyYWRlIGZpbGUgJXM6ICV2JnF1b3Q7LCB1cGdyYWRlSW5mb1BhdGgsIGVycikKCQl9CgkJcmV0dXJuIG5pbAoJfQp9CgovLyBMb2FkVmVyc2lvbiBsb2FkcyB0aGUgQmFzZUFwcCBhcHBsaWNhdGlvbiB2ZXJzaW9uLiBJdCB3aWxsIHBhbmljIGlmIGNhbGxlZAovLyBtb3JlIHRoYW4gb25jZSBvbiBhIHJ1bm5pbmcgYmFzZWFwcC4KZnVuYyAoYXBwICpCYXNlQXBwKSBMb2FkVmVyc2lvbih2ZXJzaW9uIGludDY0LCBiYXNlS2V5ICpzZGsuS1ZTdG9yZUtleSkgZXJyb3IgewoJZXJyIDo9IGFwcC5jbXMuTG9hZFZlcnNpb24odmVyc2lvbikKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBlcnIKCX0KCXJldHVybiBhcHAuaW5pdEZyb21NYWluU3RvcmUoYmFzZUtleSkKfQoKLy8gTGFzdENvbW1pdElEIHJldHVybnMgdGhlIGxhc3QgQ29tbWl0SUQgb2YgdGhlIG11bHRpc3RvcmUuCmZ1bmMgKGFwcCAqQmFzZUFwcCkgTGFzdENvbW1pdElEKCkgc2RrLkNvbW1pdElEIHsKCXJldHVybiBhcHAuY21zLkxhc3RDb21taXRJRCgpCn0KCi8vIExhc3RCbG9ja0hlaWdodCByZXR1cm5zIHRoZSBsYXN0IGNvbW1pdHRlZCBibG9jayBoZWlnaHQuCmZ1bmMgKGFwcCAqQmFzZUFwcCkgTGFzdEJsb2NrSGVpZ2h0KCkgaW50NjQgewoJcmV0dXJuIGFwcC5jbXMuTGFzdENvbW1pdElEKCkuVmVyc2lvbgp9CgovLyBpbml0aWFsaXplcyB0aGUgcmVtYWluaW5nIGxvZ2ljIGZyb20gYXBwLmNtcwpmdW5jIChhcHAgKkJhc2VBcHApIGluaXRGcm9tTWFpblN0b3JlKGJhc2VLZXkgKnNkay5LVlN0b3JlS2V5KSBlcnJvciB7CgltYWluU3RvcmUgOj0gYXBwLmNtcy5HZXRLVlN0b3JlKGJhc2VLZXkpCglpZiBtYWluU3RvcmUgPT0gbmlsIHsKCQlyZXR1cm4gZXJyb3JzLk5ldygmcXVvdDtiYXNlYXBwIGV4cGVjdHMgTXVsdGlTdG9yZSB3aXRoICdtYWluJyBLVlN0b3JlJnF1b3Q7KQoJfQoKCS8vIG1lbW9pemUgYmFzZUtleQoJaWYgYXBwLmJhc2VLZXkgIT0gbmlsIHsKCQlwYW5pYygmcXVvdDthcHAuYmFzZUtleSBleHBlY3RlZCB0byBiZSBuaWw7IGR1cGxpY2F0ZSBpbml0PyZxdW90OykKCX0KCWFwcC5iYXNlS2V5ID0gYmFzZUtleQoKCS8vIExvYWQgdGhlIGNvbnNlbnN1cyBwYXJhbXMgZnJvbSB0aGUgbWFpbiBzdG9yZS4gSWYgdGhlIGNvbnNlbnN1cyBwYXJhbXMgYXJlCgkvLyBuaWwsIGl0IHdpbGwgYmUgc2F2ZWQgbGF0ZXIgZHVyaW5nIEluaXRDaGFpbi4KCS8vCgkvLyBUT0RPOiBhc3NlcnQgdGhhdCBJbml0Q2hhaW4gaGFzbid0IHlldCBiZWVuIGNhbGxlZC4KCWNvbnNlbnN1c1BhcmFtc0J6IDo9IG1haW5TdG9yZS5HZXQobWFpbkNvbnNlbnN1c1BhcmFtc0tleSkKCWlmIGNvbnNlbnN1c1BhcmFtc0J6ICE9IG5pbCB7CgkJdmFyIGNvbnNlbnN1c1BhcmFtcyA9ICZhbXA7YWJjaS5Db25zZW5zdXNQYXJhbXN7fQoKCQllcnIgOj0gcHJvdG8uVW5tYXJzaGFsKGNvbnNlbnN1c1BhcmFtc0J6LCBjb25zZW5zdXNQYXJhbXMpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXBhbmljKGVycikKCQl9CgoJCWFwcC5zZXRDb25zZW5zdXNQYXJhbXMoY29uc2Vuc3VzUGFyYW1zKQoJfQoKCS8vIG5lZWRlZCBmb3IgdGhlIGV4cG9ydCBjb21tYW5kIHdoaWNoIGluaXRzIGZyb20gc3RvcmUgYnV0IG5ldmVyIGNhbGxzIGluaXRjaGFpbgoJYXBwLnNldENoZWNrU3RhdGUoYWJjaS5IZWFkZXJ7fSkKCWFwcC5TZWFsKCkKCglyZXR1cm4gbmlsCn0KCmZ1bmMgKGFwcCAqQmFzZUFwcCkgc2V0TWluR2FzUHJpY2VzKGdhc1ByaWNlcyBzZGsuRGVjQ29pbnMpIHsKCWFwcC5taW5HYXNQcmljZXMgPSBnYXNQcmljZXMKfQoKZnVuYyAoYXBwICpCYXNlQXBwKSBzZXRIYWx0SGVpZ2h0KGhhbHRIZWlnaHQgdWludDY0KSB7CglhcHAuaGFsdEhlaWdodCA9IGhhbHRIZWlnaHQKfQoKZnVuYyAoYXBwICpCYXNlQXBwKSBzZXRIYWx0VGltZShoYWx0VGltZSB1aW50NjQpIHsKCWFwcC5oYWx0VGltZSA9IGhhbHRUaW1lCn0KCmZ1bmMgKGFwcCAqQmFzZUFwcCkgc2V0SW50ZXJCbG9ja0NhY2hlKGNhY2hlIHNkay5NdWx0aVN0b3JlUGVyc2lzdGVudENhY2hlKSB7CglhcHAuaW50ZXJCbG9ja0NhY2hlID0gY2FjaGUKfQoKLy8gUm91dGVyIHJldHVybnMgdGhlIHJvdXRlciBvZiB0aGUgQmFzZUFwcC4KZnVuYyAoYXBwICpCYXNlQXBwKSBSb3V0ZXIoKSBzZGsuUm91dGVyIHsKCWlmIGFwcC5zZWFsZWQgewoJCS8vIFdlIGNhbm5vdCByZXR1cm4gYSBSb3V0ZXIgd2hlbiB0aGUgYXBwIGlzIHNlYWxlZCBiZWNhdXNlIHdlIGNhbid0IGhhdmUKCQkvLyBhbnkgcm91dGVzIG1vZGlmaWVkIHdoaWNoIHdvdWxkIGNhdXNlIHVuZXhwZWN0ZWQgcm91dGluZyBiZWhhdmlvci4KCQlwYW5pYygmcXVvdDtSb3V0ZXIoKSBvbiBzZWFsZWQgQmFzZUFwcCZxdW90OykKCX0KCXJldHVybiBhcHAucm91dGVyCn0KCi8vIFF1ZXJ5Um91dGVyIHJldHVybnMgdGhlIFF1ZXJ5Um91dGVyIG9mIGEgQmFzZUFwcC4KZnVuYyAoYXBwICpCYXNlQXBwKSBRdWVyeVJvdXRlcigpIHNkay5RdWVyeVJvdXRlciB7IHJldHVybiBhcHAucXVlcnlSb3V0ZXIgfQoKLy8gU2VhbCBzZWFscyBhIEJhc2VBcHAuIEl0IHByb2hpYml0cyBhbnkgZnVydGhlciBtb2RpZmljYXRpb25zIHRvIGEgQmFzZUFwcC4KZnVuYyAoYXBwICpCYXNlQXBwKSBTZWFsKCkgeyBhcHAuc2VhbGVkID0gdHJ1ZSB9CgovLyBJc1NlYWxlZCByZXR1cm5zIHRydWUgaWYgdGhlIEJhc2VBcHAgaXMgc2VhbGVkIGFuZCBmYWxzZSBvdGhlcndpc2UuCmZ1bmMgKGFwcCAqQmFzZUFwcCkgSXNTZWFsZWQoKSBib29sIHsgcmV0dXJuIGFwcC5zZWFsZWQgfQoKLy8gc2V0Q2hlY2tTdGF0ZSBzZXRzIHRoZSBCYXNlQXBwJ3MgY2hlY2tTdGF0ZSB3aXRoIGEgY2FjaGUtd3JhcHBlZCBtdWx0aS1zdG9yZQovLyAoaS5lLiBhIENhY2hlTXVsdGlTdG9yZSkgYW5kIGEgbmV3IENvbnRleHQgd2l0aCB0aGUgY2FjaGUtd3JhcHBlZCBtdWx0aS1zdG9yZSwKLy8gcHJvdmlkZWQgaGVhZGVyLCBhbmQgbWluaW11bSBnYXMgcHJpY2VzIHNldC4gSXQgaXMgc2V0IG9uIEluaXRDaGFpbiBhbmQgcmVzZXQKLy8gb24gQ29tbWl0LgpmdW5jIChhcHAgKkJhc2VBcHApIHNldENoZWNrU3RhdGUoaGVhZGVyIGFiY2kuSGVhZGVyKSB7CgltcyA6PSBhcHAuY21zLkNhY2hlTXVsdGlTdG9yZSgpCglhcHAuY2hlY2tTdGF0ZSA9ICZhbXA7c3RhdGV7CgkJbXM6ICBtcywKCQljdHg6IHNkay5OZXdDb250ZXh0KG1zLCBoZWFkZXIsIHRydWUsIGFwcC5sb2dnZXIpLldpdGhNaW5HYXNQcmljZXMoYXBwLm1pbkdhc1ByaWNlcyksCgl9Cn0KCi8vIHNldERlbGl2ZXJTdGF0ZSBzZXRzIHRoZSBCYXNlQXBwJ3MgZGVsaXZlclN0YXRlIHdpdGggYSBjYWNoZS13cmFwcGVkIG11bHRpLXN0b3JlCi8vIChpLmUuIGEgQ2FjaGVNdWx0aVN0b3JlKSBhbmQgYSBuZXcgQ29udGV4dCB3aXRoIHRoZSBjYWNoZS13cmFwcGVkIG11bHRpLXN0b3JlLAovLyBhbmQgcHJvdmlkZWQgaGVhZGVyLiBJdCBpcyBzZXQgb24gSW5pdENoYWluIGFuZCBCZWdpbkJsb2NrIGFuZCBzZXQgdG8gbmlsIG9uCi8vIENvbW1pdC4KZnVuYyAoYXBwICpCYXNlQXBwKSBzZXREZWxpdmVyU3RhdGUoaGVhZGVyIGFiY2kuSGVhZGVyKSB7CgltcyA6PSBhcHAuY21zLkNhY2hlTXVsdGlTdG9yZSgpCglhcHAuZGVsaXZlclN0YXRlID0gJmFtcDtzdGF0ZXsKCQltczogIG1zLAoJCWN0eDogc2RrLk5ld0NvbnRleHQobXMsIGhlYWRlciwgZmFsc2UsIGFwcC5sb2dnZXIpLAoJfQp9CgovLyBzZXRDb25zZW5zdXNQYXJhbXMgbWVtb2l6ZXMgdGhlIGNvbnNlbnN1cyBwYXJhbXMuCmZ1bmMgKGFwcCAqQmFzZUFwcCkgc2V0Q29uc2Vuc3VzUGFyYW1zKGNvbnNlbnN1c1BhcmFtcyAqYWJjaS5Db25zZW5zdXNQYXJhbXMpIHsKCWFwcC5jb25zZW5zdXNQYXJhbXMgPSBjb25zZW5zdXNQYXJhbXMKfQoKLy8gc2V0Q29uc2Vuc3VzUGFyYW1zIHN0b3JlcyB0aGUgY29uc2Vuc3VzIHBhcmFtcyB0byB0aGUgbWFpbiBzdG9yZS4KZnVuYyAoYXBwICpCYXNlQXBwKSBzdG9yZUNvbnNlbnN1c1BhcmFtcyhjb25zZW5zdXNQYXJhbXMgKmFiY2kuQ29uc2Vuc3VzUGFyYW1zKSB7Cgljb25zZW5zdXNQYXJhbXNCeiwgZXJyIDo9IHByb3RvLk1hcnNoYWwoY29uc2Vuc3VzUGFyYW1zKQoJaWYgZXJyICE9IG5pbCB7CgkJcGFuaWMoZXJyKQoJfQoJbWFpblN0b3JlIDo9IGFwcC5jbXMuR2V0S1ZTdG9yZShhcHAuYmFzZUtleSkKCW1haW5TdG9yZS5TZXQobWFpbkNvbnNlbnN1c1BhcmFtc0tleSwgY29uc2Vuc3VzUGFyYW1zQnopCn0KCi8vIGdldE1heGltdW1CbG9ja0dhcyBnZXRzIHRoZSBtYXhpbXVtIGdhcyBmcm9tIHRoZSBjb25zZW5zdXMgcGFyYW1zLiBJdCBwYW5pY3MKLy8gaWYgbWF4aW11bSBibG9jayBnYXMgaXMgbGVzcyB0aGFuIG5lZ2F0aXZlIG9uZSBhbmQgcmV0dXJucyB6ZXJvIGlmIG5lZ2F0aXZlCi8vIG9uZS4KZnVuYyAoYXBwICpCYXNlQXBwKSBnZXRNYXhpbXVtQmxvY2tHYXMoKSB1aW50NjQgewoJaWYgYXBwLmNvbnNlbnN1c1BhcmFtcyA9PSBuaWwgfHwgYXBwLmNvbnNlbnN1c1BhcmFtcy5CbG9jayA9PSBuaWwgewoJCXJldHVybiAwCgl9CgoJbWF4R2FzIDo9IGFwcC5jb25zZW5zdXNQYXJhbXMuQmxvY2suTWF4R2FzCglzd2l0Y2ggewoJY2FzZSBtYXhHYXMgJmx0OyAtMToKCQlwYW5pYyhmbXQuU3ByaW50ZigmcXVvdDtpbnZhbGlkIG1heGltdW0gYmxvY2sgZ2FzOiAlZCZxdW90OywgbWF4R2FzKSkKCgljYXNlIG1heEdhcyA9PSAtMToKCQlyZXR1cm4gMAoKCWRlZmF1bHQ6CgkJcmV0dXJuIHVpbnQ2NChtYXhHYXMpCgl9Cn0KCmZ1bmMgKGFwcCAqQmFzZUFwcCkgdmFsaWRhdGVIZWlnaHQocmVxIGFiY2kuUmVxdWVzdEJlZ2luQmxvY2spIGVycm9yIHsKCWlmIHJlcS5IZWFkZXIuSGVpZ2h0ICZsdDsgMSB7CgkJcmV0dXJuIGZtdC5FcnJvcmYoJnF1b3Q7aW52YWxpZCBoZWlnaHQ6ICVkJnF1b3Q7LCByZXEuSGVhZGVyLkhlaWdodCkKCX0KCglwcmV2SGVpZ2h0IDo9IGFwcC5MYXN0QmxvY2tIZWlnaHQoKQoJaWYgcmVxLkhlYWRlci5IZWlnaHQgIT0gcHJldkhlaWdodCsxIHsKCQlyZXR1cm4gZm10LkVycm9yZigmcXVvdDtpbnZhbGlkIGhlaWdodDogJWQ7IGV4cGVjdGVkOiAlZCZxdW90OywgcmVxLkhlYWRlci5IZWlnaHQsIHByZXZIZWlnaHQrMSkKCX0KCglyZXR1cm4gbmlsCn0KCi8vIHZhbGlkYXRlQmFzaWNUeE1zZ3MgZXhlY3V0ZXMgYmFzaWMgdmFsaWRhdG9yIGNhbGxzIGZvciBtZXNzYWdlcy4KZnVuYyB2YWxpZGF0ZUJhc2ljVHhNc2dzKG1zZ3MgW11zZGsuTXNnKSBzZGsuRXJyb3IgewoJaWYgbGVuKG1zZ3MpID09IDAgewoJCXJldHVybiBzZGsuRXJyVW5rbm93blJlcXVlc3QoJnF1b3Q7VHguR2V0TXNncygpIG11c3QgcmV0dXJuIGF0IGxlYXN0IG9uZSBtZXNzYWdlIGluIGxpc3QmcXVvdDspCgl9CgoJZm9yIF8sIG1zZyA6PSByYW5nZSBtc2dzIHsKCQkvLyBWYWxpZGF0ZSB0aGUgTXNnLgoJCWVyciA6PSBtc2cuVmFsaWRhdGVCYXNpYygpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybiBlcnIKCQl9Cgl9CgoJcmV0dXJuIG5pbAp9CgovLyBSZXR1cm5zIHRoZSBhcHBsaWNhdGlvbnMncyBkZWxpdmVyU3RhdGUgaWYgYXBwIGlzIGluIHJ1blR4TW9kZURlbGl2ZXIsCi8vIG90aGVyd2lzZSBpdCByZXR1cm5zIHRoZSBhcHBsaWNhdGlvbidzIGNoZWNrc3RhdGUuCmZ1bmMgKGFwcCAqQmFzZUFwcCkgZ2V0U3RhdGUobW9kZSBydW5UeE1vZGUpICpzdGF0ZSB7CglpZiBtb2RlID09IHJ1blR4TW9kZURlbGl2ZXIgewoJCXJldHVybiBhcHAuZGVsaXZlclN0YXRlCgl9CgoJcmV0dXJuIGFwcC5jaGVja1N0YXRlCn0KCi8vIHJldHJpZXZlIHRoZSBjb250ZXh0IGZvciB0aGUgdHggdy8gdHhCeXRlcyBhbmQgb3RoZXIgbWVtb2l6ZWQgdmFsdWVzLgpmdW5jIChhcHAgKkJhc2VBcHApIGdldENvbnRleHRGb3JUeChtb2RlIHJ1blR4TW9kZSwgdHhCeXRlcyBbXWJ5dGUpIHNkay5Db250ZXh0IHsKCWN0eCA6PSBhcHAuZ2V0U3RhdGUobW9kZSkuY3R4LgoJCVdpdGhUeEJ5dGVzKHR4Qnl0ZXMpLgoJCVdpdGhWb3RlSW5mb3MoYXBwLnZvdGVJbmZvcykuCgkJV2l0aENvbnNlbnN1c1BhcmFtcyhhcHAuY29uc2Vuc3VzUGFyYW1zKQoKCWlmIG1vZGUgPT0gcnVuVHhNb2RlUmVDaGVjayB7CgkJY3R4ID0gY3R4LldpdGhJc1JlQ2hlY2tUeCh0cnVlKQoJfQoJaWYgbW9kZSA9PSBydW5UeE1vZGVTaW11bGF0ZSB7CgkJY3R4LCBfID0gY3R4LkNhY2hlQ29udGV4dCgpCgl9CgoJcmV0dXJuIGN0eAp9CgovLyBjYWNoZVR4Q29udGV4dCByZXR1cm5zIGEgbmV3IGNvbnRleHQgYmFzZWQgb2ZmIG9mIHRoZSBwcm92aWRlZCBjb250ZXh0IHdpdGgKLy8gYSBjYWNoZSB3cmFwcGVkIG11bHRpLXN0b3JlLgpmdW5jIChhcHAgKkJhc2VBcHApIGNhY2hlVHhDb250ZXh0KGN0eCBzZGsuQ29udGV4dCwgdHhCeXRlcyBbXWJ5dGUpIChzZGsuQ29udGV4dCwgc2RrLkNhY2hlTXVsdGlTdG9yZSkgewoJbXMgOj0gY3R4Lk11bHRpU3RvcmUoKQoJLy8gVE9ETzogaHR0cHM6Ly9naXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL2lzc3Vlcy8yODI0Cgltc0NhY2hlIDo9IG1zLkNhY2hlTXVsdGlTdG9yZSgpCglpZiBtc0NhY2hlLlRyYWNpbmdFbmFibGVkKCkgewoJCW1zQ2FjaGUgPSBtc0NhY2hlLlNldFRyYWNpbmdDb250ZXh0KAoJCQlzZGsuVHJhY2VDb250ZXh0KAoJCQkJbWFwW3N0cmluZ11pbnRlcmZhY2V7fXsKCQkJCQkmcXVvdDt0eEhhc2gmcXVvdDs6IGZtdC5TcHJpbnRmKCZxdW90OyVYJnF1b3Q7LCB0bWhhc2guU3VtKHR4Qnl0ZXMpKSwKCQkJCX0sCgkJCSksCgkJKS4oc2RrLkNhY2hlTXVsdGlTdG9yZSkKCX0KCglyZXR1cm4gY3R4LldpdGhNdWx0aVN0b3JlKG1zQ2FjaGUpLCBtc0NhY2hlCn0KCi8vIHJ1blR4IHByb2Nlc3NlcyBhIHRyYW5zYWN0aW9uLiBUaGUgdHJhbnNhY3Rpb25zIGlzIHByb2Nlc3NlZCB2aWEgYW4KLy8gYW50ZUhhbmRsZXIuIFRoZSBwcm92aWRlZCB0eEJ5dGVzIG1heSBiZSBuaWwgaW4gc29tZSBjYXNlcywgZWcuIGluIHRlc3RzLiBGb3IKLy8gZnVydGhlciBkZXRhaWxzIG9uIHRyYW5zYWN0aW9uIGV4ZWN1dGlvbiwgcmVmZXJlbmNlIHRoZSBCYXNlQXBwIFNESwovLyBkb2N1bWVudGF0aW9uLgpmdW5jIChhcHAgKkJhc2VBcHApIHJ1blR4KG1vZGUgcnVuVHhNb2RlLCB0eEJ5dGVzIFtdYnl0ZSwgdHggc2RrLlR4KSAocmVzdWx0IHNkay5SZXN1bHQpIHsKCS8vIE5PVEU6IEdhc1dhbnRlZCBzaG91bGQgYmUgcmV0dXJuZWQgYnkgdGhlIEFudGVIYW5kbGVyLiBHYXNVc2VkIGlzCgkvLyBkZXRlcm1pbmVkIGJ5IHRoZSBHYXNNZXRlci4gV2UgbmVlZCBhY2Nlc3MgdG8gdGhlIGNvbnRleHQgdG8gZ2V0IHRoZSBnYXMKCS8vIG1ldGVyIHNvIHdlIGluaXRpYWxpemUgdXBmcm9udC4KCXZhciBnYXNXYW50ZWQgdWludDY0CgoJY3R4IDo9IGFwcC5nZXRDb250ZXh0Rm9yVHgobW9kZSwgdHhCeXRlcykKCW1zIDo9IGN0eC5NdWx0aVN0b3JlKCkKCgkvLyBvbmx5IHJ1biB0aGUgdHggaWYgdGhlcmUgaXMgYmxvY2sgZ2FzIHJlbWFpbmluZwoJaWYgbW9kZSA9PSBydW5UeE1vZGVEZWxpdmVyICZhbXA7JmFtcDsgY3R4LkJsb2NrR2FzTWV0ZXIoKS5Jc091dE9mR2FzKCkgewoJCXJldHVybiBzZGsuRXJyT3V0T2ZHYXMoJnF1b3Q7bm8gYmxvY2sgZ2FzIGxlZnQgdG8gcnVuIHR4JnF1b3Q7KS5SZXN1bHQoKQoJfQoKCXZhciBzdGFydGluZ0dhcyB1aW50NjQKCWlmIG1vZGUgPT0gcnVuVHhNb2RlRGVsaXZlciB7CgkJc3RhcnRpbmdHYXMgPSBjdHguQmxvY2tHYXNNZXRlcigpLkdhc0NvbnN1bWVkKCkKCX0KCglkZWZlciBmdW5jKCkgewoJCWlmIHIgOj0gcmVjb3ZlcigpOyByICE9IG5pbCB7CgkJCXN3aXRjaCByVHlwZSA6PSByLih0eXBlKSB7CgkJCWNhc2Ugc2RrLkVycm9yT3V0T2ZHYXM6CgkJCQlsb2cgOj0gZm10LlNwcmludGYoCgkJCQkJJnF1b3Q7b3V0IG9mIGdhcyBpbiBsb2NhdGlvbjogJXY7IGdhc1dhbnRlZDogJWQsIGdhc1VzZWQ6ICVkJnF1b3Q7LAoJCQkJCXJUeXBlLkRlc2NyaXB0b3IsIGdhc1dhbnRlZCwgY3R4Lkdhc01ldGVyKCkuR2FzQ29uc3VtZWQoKSwKCQkJCSkKCQkJCXJlc3VsdCA9IHNkay5FcnJPdXRPZkdhcyhsb2cpLlJlc3VsdCgpCgkJCWRlZmF1bHQ6CgkJCQlsb2cgOj0gZm10LlNwcmludGYoJnF1b3Q7cmVjb3ZlcmVkOiAldlxuc3RhY2s6XG4ldiZxdW90Oywgciwgc3RyaW5nKGRlYnVnLlN0YWNrKCkpKQoJCQkJcmVzdWx0ID0gc2RrLkVyckludGVybmFsKGxvZykuUmVzdWx0KCkKCQkJfQoJCX0KCgkJcmVzdWx0Lkdhc1dhbnRlZCA9IGdhc1dhbnRlZAoJCXJlc3VsdC5HYXNVc2VkID0gY3R4Lkdhc01ldGVyKCkuR2FzQ29uc3VtZWQoKQoJfSgpCgoJLy8gSWYgQmxvY2tHYXNNZXRlcigpIHBhbmljcyBpdCB3aWxsIGJlIGNhdWdodCBieSB0aGUgYWJvdmUgcmVjb3ZlciBhbmQgd2lsbAoJLy8gcmV0dXJuIGFuIGVycm9yIC0gaW4gYW55IGNhc2UgQmxvY2tHYXNNZXRlciB3aWxsIGNvbnN1bWUgZ2FzIHBhc3QgdGhlIGxpbWl0LgoJLy8KCS8vIE5PVEU6IFRoaXMgbXVzdCBleGlzdCBpbiBhIHNlcGFyYXRlIGRlZmVyIGZ1bmN0aW9uIGZvciB0aGUgYWJvdmUgcmVjb3ZlcnkKCS8vIHRvIHJlY292ZXIgZnJvbSB0aGlzIG9uZS4KCWRlZmVyIGZ1bmMoKSB7CgkJaWYgbW9kZSA9PSBydW5UeE1vZGVEZWxpdmVyIHsKCQkJY3R4LkJsb2NrR2FzTWV0ZXIoKS5Db25zdW1lR2FzKAoJCQkJY3R4Lkdhc01ldGVyKCkuR2FzQ29uc3VtZWRUb0xpbWl0KCksCgkJCQkmcXVvdDtibG9jayBnYXMgbWV0ZXImcXVvdDssCgkJCSkKCgkJCWlmIGN0eC5CbG9ja0dhc01ldGVyKCkuR2FzQ29uc3VtZWQoKSAmbHQ7IHN0YXJ0aW5nR2FzIHsKCQkJCXBhbmljKHNkay5FcnJvckdhc092ZXJmbG93e0Rlc2NyaXB0b3I6ICZxdW90O3R4IGdhcyBzdW1tYXRpb24mcXVvdDt9KQoJCQl9CgkJfQoJfSgpCgoJdmFyIG1zZ3MgPSB0eC5HZXRNc2dzKCkKCWlmIGVyciA6PSB2YWxpZGF0ZUJhc2ljVHhNc2dzKG1zZ3MpOyBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gZXJyLlJlc3VsdCgpCgl9CgoJaWYgYXBwLmFudGVIYW5kbGVyICE9IG5pbCB7CgkJdmFyIGFudGVDdHggc2RrLkNvbnRleHQKCQl2YXIgbXNDYWNoZSBzZGsuQ2FjaGVNdWx0aVN0b3JlCgoJCS8vIENhY2hlIHdyYXAgY29udGV4dCBiZWZvcmUgYW50ZUhhbmRsZXIgY2FsbCBpbiBjYXNlIGl0IGFib3J0cy4KCQkvLyBUaGlzIGlzIHJlcXVpcmVkIGZvciBib3RoIENoZWNrVHggYW5kIERlbGl2ZXJUeC4KCQkvLyBSZWY6IGh0dHBzOi8vZ2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9pc3N1ZXMvMjc3MgoJCS8vCgkJLy8gTk9URTogQWx0ZXJuYXRpdmVseSwgd2UgY291bGQgcmVxdWlyZSB0aGF0IGFudGVIYW5kbGVyIGVuc3VyZXMgdGhhdAoJCS8vIHdyaXRlcyBkbyBub3QgaGFwcGVuIGlmIGFib3J0ZWQvZmFpbGVkLiAgVGhpcyBtYXkgaGF2ZSBzb21lCgkJLy8gcGVyZm9ybWFuY2UgYmVuZWZpdHMsIGJ1dCBpdCdsbCBiZSBtb3JlIGRpZmZpY3VsdCB0byBnZXQgcmlnaHQuCgkJYW50ZUN0eCwgbXNDYWNoZSA9IGFwcC5jYWNoZVR4Q29udGV4dChjdHgsIHR4Qnl0ZXMpCgoJCW5ld0N0eCwgZXJyIDo9IGFwcC5hbnRlSGFuZGxlcihhbnRlQ3R4LCB0eCwgbW9kZSA9PSBydW5UeE1vZGVTaW11bGF0ZSkKCQlpZiAhbmV3Q3R4LklzWmVybygpIHsKCQkJLy8gQXQgdGhpcyBwb2ludCwgbmV3Q3R4Lk11bHRpU3RvcmUoKSBpcyBjYWNoZS13cmFwcGVkLCBvciBzb21ldGhpbmcgZWxzZQoJCQkvLyByZXBsYWNlZCBieSB0aGUgYW50ZSBoYW5kbGVyLiBXZSB3YW50IHRoZSBvcmlnaW5hbCBtdWx0aXN0b3JlLCBub3Qgb25lCgkJCS8vIHdoaWNoIHdhcyBjYWNoZS13cmFwcGVkIGZvciB0aGUgYW50ZSBoYW5kbGVyLgoJCQkvLwoJCQkvLyBBbHNvLCBpbiB0aGUgY2FzZSBvZiB0aGUgdHggYWJvcnRpbmcsIHdlIG5lZWQgdG8gdHJhY2sgZ2FzIGNvbnN1bWVkIHZpYQoJCQkvLyB0aGUgaW5zdGFudGlhdGVkIGdhcyBtZXRlciBpbiB0aGUgYW50ZSBoYW5kbGVyLCBzbyB3ZSB1cGRhdGUgdGhlIGNvbnRleHQKCQkJLy8gcHJpb3IgdG8gcmV0dXJuaW5nLgoJCQljdHggPSBuZXdDdHguV2l0aE11bHRpU3RvcmUobXMpCgkJfQoKCQkvLyBHYXNNZXRlciBleHBlY3RlZCB0byBiZSBzZXQgaW4gQW50ZUhhbmRsZXIKCQlnYXNXYW50ZWQgPSBjdHguR2FzTWV0ZXIoKS5MaW1pdCgpCgoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXMgOj0gc2RrLlJlc3VsdEZyb21FcnJvcihlcnIpCgkJCXJlcy5HYXNXYW50ZWQgPSBnYXNXYW50ZWQKCQkJcmVzLkdhc1VzZWQgPSBjdHguR2FzTWV0ZXIoKS5HYXNDb25zdW1lZCgpCgkJCXJldHVybiByZXMKCQl9CgoJCW1zQ2FjaGUuV3JpdGUoKQoJfQoKCS8vIENyZWF0ZSBhIG5ldyBDb250ZXh0IGJhc2VkIG9mZiBvZiB0aGUgZXhpc3RpbmcgQ29udGV4dCB3aXRoIGEgY2FjaGUtd3JhcHBlZAoJLy8gTXVsdGlTdG9yZSBpbiBjYXNlIG1lc3NhZ2UgcHJvY2Vzc2luZyBmYWlscy4gQXQgdGhpcyBwb2ludCwgdGhlIE11bHRpU3RvcmUKCS8vIGlzIGRvdWJseSBjYWNoZWQtd3JhcHBlZC4KCXJ1bk1zZ0N0eCwgbXNDYWNoZSA6PSBhcHAuY2FjaGVUeENvbnRleHQoY3R4LCB0eEJ5dGVzKQoJcmVzdWx0ID0gYXBwLnJ1bk1zZ3MocnVuTXNnQ3R4LCBtc2dzLCBtb2RlKQoJcmVzdWx0Lkdhc1dhbnRlZCA9IGdhc1dhbnRlZAoKCS8vIFNhZmV0eSBjaGVjazogZG9uJ3Qgd3JpdGUgdGhlIGNhY2hlIHN0YXRlIHVubGVzcyB3ZSdyZSBpbiBEZWxpdmVyVHguCglpZiBtb2RlICE9IHJ1blR4TW9kZURlbGl2ZXIgewoJCXJldHVybiByZXN1bHQKCX0KCgkvLyBvbmx5IHVwZGF0ZSBzdGF0ZSBpZiBhbGwgbWVzc2FnZXMgcGFzcwoJaWYgcmVzdWx0LklzT0soKSB7CgkJbXNDYWNoZS5Xcml0ZSgpCgl9CgoJcmV0dXJuIHJlc3VsdAp9CgovLyBydW5Nc2dzIGl0ZXJhdGVzIHRocm91Z2ggYWxsIHRoZSBtZXNzYWdlcyBhbmQgZXhlY3V0ZXMgdGhlbS4KZnVuYyAoYXBwICpCYXNlQXBwKSBydW5Nc2dzKGN0eCBzZGsuQ29udGV4dCwgbXNncyBbXXNkay5Nc2csIG1vZGUgcnVuVHhNb2RlKSAocmVzdWx0IHNkay5SZXN1bHQpIHsKCW1zZ0xvZ3MgOj0gbWFrZShzZGsuQUJDSU1lc3NhZ2VMb2dzLCAwLCBsZW4obXNncykpCgoJZGF0YSA6PSBtYWtlKFtdYnl0ZSwgMCwgbGVuKG1zZ3MpKQoJdmFyICgKCQljb2RlICAgICAgc2RrLkNvZGVUeXBlCgkJY29kZXNwYWNlIHNkay5Db2Rlc3BhY2VUeXBlCgkpCgoJZXZlbnRzIDo9IHNkay5FbXB0eUV2ZW50cygpCgoJLy8gTk9URTogR2FzV2FudGVkIGlzIGRldGVybWluZWQgYnkgYW50ZSBoYW5kbGVyIGFuZCBHYXNVc2VkIGJ5IHRoZSBHYXNNZXRlci4KCWZvciBpLCBtc2cgOj0gcmFuZ2UgbXNncyB7CgkJLy8gbWF0Y2ggbWVzc2FnZSByb3V0ZQoJCW1zZ1JvdXRlIDo9IG1zZy5Sb3V0ZSgpCgkJaGFuZGxlciA6PSBhcHAucm91dGVyLlJvdXRlKG1zZ1JvdXRlKQoJCWlmIGhhbmRsZXIgPT0gbmlsIHsKCQkJcmV0dXJuIHNkay5FcnJVbmtub3duUmVxdWVzdCgmcXVvdDt1bnJlY29nbml6ZWQgbWVzc2FnZSB0eXBlOiAmcXVvdDsgKyBtc2dSb3V0ZSkuUmVzdWx0KCkKCQl9CgoJCXZhciBtc2dSZXN1bHQgc2RrLlJlc3VsdAoKCQkvLyBza2lwIGFjdHVhbCBleGVjdXRpb24gZm9yIENoZWNrVHggYW5kIFJlQ2hlY2tUeCBtb2RlCgkJaWYgbW9kZSAhPSBydW5UeE1vZGVDaGVjayAmYW1wOyZhbXA7IG1vZGUgIT0gcnVuVHhNb2RlUmVDaGVjayB7CgkJCW1zZ1Jlc3VsdCA9IGhhbmRsZXIoY3R4LCBtc2cpCgkJfQoKCQkvLyBFYWNoIG1lc3NhZ2UgcmVzdWx0J3MgRGF0YSBtdXN0IGJlIGxlbmd0aCBwcmVmaXhlZCBpbiBvcmRlciB0byBzZXBhcmF0ZQoJCS8vIGVhY2ggcmVzdWx0LgoJCWRhdGEgPSBhcHBlbmQoZGF0YSwgbXNnUmVzdWx0LkRhdGEuLi4pCgoJCW1zZ0V2ZW50cyA6PSBtc2dSZXN1bHQuRXZlbnRzCgoJCS8vIGFwcGVuZCBldmVudHMgZnJvbSB0aGUgbWVzc2FnZSdzIGV4ZWN1dGlvbiBhbmQgYSBtZXNzYWdlIGFjdGlvbiBldmVudAoJCW1zZ0V2ZW50cyA9IG1zZ0V2ZW50cy5BcHBlbmRFdmVudCgKCQkJc2RrLk5ld0V2ZW50KHNkay5FdmVudFR5cGVNZXNzYWdlLCBzZGsuTmV3QXR0cmlidXRlKHNkay5BdHRyaWJ1dGVLZXlBY3Rpb24sIG1zZy5UeXBlKCkpKSwKCQkpCgoJCWV2ZW50cyA9IGV2ZW50cy5BcHBlbmRFdmVudHMobXNnRXZlbnRzKQoKCQkvLyBzdG9wIGV4ZWN1dGlvbiBhbmQgcmV0dXJuIG9uIGZpcnN0IGZhaWxlZCBtZXNzYWdlCgkJaWYgIW1zZ1Jlc3VsdC5Jc09LKCkgewoJCQltc2dMb2dzID0gYXBwZW5kKG1zZ0xvZ3MsIHNkay5OZXdBQkNJTWVzc2FnZUxvZyh1aW50MTYoaSksIGZhbHNlLCBtc2dSZXN1bHQuTG9nLCBtc2dFdmVudHMpKQoKCQkJY29kZSA9IG1zZ1Jlc3VsdC5Db2RlCgkJCWNvZGVzcGFjZSA9IG1zZ1Jlc3VsdC5Db2Rlc3BhY2UKCQkJYnJlYWsKCQl9CgoJCW1zZ0xvZ3MgPSBhcHBlbmQobXNnTG9ncywgc2RrLk5ld0FCQ0lNZXNzYWdlTG9nKHVpbnQxNihpKSwgdHJ1ZSwgbXNnUmVzdWx0LkxvZywgbXNnRXZlbnRzKSkKCX0KCglyZXN1bHQgPSBzZGsuUmVzdWx0ewoJCUNvZGU6ICAgICAgY29kZSwKCQlDb2Rlc3BhY2U6IGNvZGVzcGFjZSwKCQlEYXRhOiAgICAgIGRhdGEsCgkJTG9nOiAgICAgICBzdHJpbmdzLlRyaW1TcGFjZShtc2dMb2dzLlN0cmluZygpKSwKCQlHYXNVc2VkOiAgIGN0eC5HYXNNZXRlcigpLkdhc0NvbnN1bWVkKCksCgkJRXZlbnRzOiAgICBldmVudHMsCgl9CgoJcmV0dXJuIHJlc3VsdAp9Cg=="}})],1),e._v(" "),a("p",[e._v("This allows "),a("code",[e._v("RunTx")]),e._v(" not to commit the changes made to the state during the execution of "),a("code",[e._v("anteHandler")]),e._v(" if it ends up failing. It also prevents the module implementing the "),a("code",[e._v("anteHandler")]),e._v(" from writing to state, which is an important part of the "),a("RouterLink",{attrs:{to:"/core/ocap.html"}},[e._v("object-capabilities")]),e._v(" of the Cosmos SDK.")],1),e._v(" "),a("p",[e._v("Finally, the "),a("a",{attrs:{href:"#runmsgs"}},[a("code",[e._v("RunMsgs()")])]),e._v(" function is called to process the "),a("code",[e._v("messages")]),e._v("s in the "),a("code",[e._v("Tx")]),e._v(". In preparation of this step, just like with the "),a("code",[e._v("anteHandler")]),e._v(", both the "),a("code",[e._v("checkState")]),e._v("/"),a("code",[e._v("deliverState")]),e._v("'s "),a("code",[e._v("context")]),e._v(" and "),a("code",[e._v("context")]),e._v("'s "),a("code",[e._v("CacheMultiStore")]),e._v(" are cached-wrapped using the "),a("code",[e._v("cacheTxContext()")]),e._v(" function.")]),e._v(" "),a("h3",{attrs:{id:"antehandler"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#antehandler"}},[e._v("#")]),e._v(" AnteHandler")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("AnteHandler")]),e._v(" is a special handler that implements the "),a("code",[e._v("anteHandler")]),e._v(" interface and is used to authenticate the transaction before the transaction's internal messages are processed.")]),e._v(" "),a("p",[a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSB0eXBlcwoKLy8gSGFuZGxlciBkZWZpbmVzIHRoZSBjb3JlIG9mIHRoZSBzdGF0ZSB0cmFuc2l0aW9uIGZ1bmN0aW9uIG9mIGFuIGFwcGxpY2F0aW9uLgp0eXBlIEhhbmRsZXIgZnVuYyhjdHggQ29udGV4dCwgbXNnIE1zZykgUmVzdWx0CgovLyBBbnRlSGFuZGxlciBhdXRoZW50aWNhdGVzIHRyYW5zYWN0aW9ucywgYmVmb3JlIHRoZWlyIGludGVybmFsIG1lc3NhZ2VzIGFyZSBoYW5kbGVkLgovLyBJZiBuZXdDdHguSXNaZXJvKCksIGN0eCBpcyB1c2VkIGluc3RlYWQuCnR5cGUgQW50ZUhhbmRsZXIgZnVuYyhjdHggQ29udGV4dCwgdHggVHgsIHNpbXVsYXRlIGJvb2wpIChuZXdDdHggQ29udGV4dCwgZXJyIGVycm9yKQoKLy8gQW50ZURlY29yYXRvciB3cmFwcyB0aGUgbmV4dCBBbnRlSGFuZGxlciB0byBwZXJmb3JtIGN1c3RvbSBwcmUtIGFuZCBwb3N0LXByb2Nlc3NpbmcuCnR5cGUgQW50ZURlY29yYXRvciBpbnRlcmZhY2UgewoJQW50ZUhhbmRsZShjdHggQ29udGV4dCwgdHggVHgsIHNpbXVsYXRlIGJvb2wsIG5leHQgQW50ZUhhbmRsZXIpIChuZXdDdHggQ29udGV4dCwgZXJyIGVycm9yKQp9CgovLyBDaGFpbkRlY29yYXRvciBjaGFpbnMgQW50ZURlY29yYXRvcnMgdG9nZXRoZXIgd2l0aCBlYWNoIEFudGVEZWNvcmF0b3IKLy8gd3JhcHBpbmcgb3ZlciB0aGUgZGVjb3JhdG9ycyBmdXJ0aGVyIGFsb25nIGNoYWluIGFuZCByZXR1cm5zIGEgc2luZ2xlIEFudGVIYW5kbGVyLgovLwovLyBOT1RFOiBUaGUgZmlyc3QgZWxlbWVudCBpcyBvdXRlcm1vc3QgZGVjb3JhdG9yLCB3aGlsZSB0aGUgbGFzdCBlbGVtZW50IGlzIGlubmVybW9zdAovLyBkZWNvcmF0b3IuIERlY29yYXRvciBvcmRlcmluZyBpcyBjcml0aWNhbCBzaW5jZSBzb21lIGRlY29yYXRvcnMgd2lsbCBleHBlY3QKLy8gY2VydGFpbiBjaGVja3MgYW5kIHVwZGF0ZXMgdG8gYmUgcGVyZm9ybWVkIChlLmcuIHRoZSBDb250ZXh0KSBiZWZvcmUgdGhlIGRlY29yYXRvcgovLyBpcyBydW4uIFRoZXNlIGV4cGVjdGF0aW9ucyBzaG91bGQgYmUgZG9jdW1lbnRlZCBjbGVhcmx5IGluIGEgQ09OVFJBQ1QgZG9jbGluZQovLyBpbiB0aGUgZGVjb3JhdG9yJ3MgZ29kb2MuCi8vCi8vIE5PVEU6IEFueSBhcHBsaWNhdGlvbiB0aGF0IHVzZXMgR2FzTWV0ZXIgdG8gbGltaXQgdHJhbnNhY3Rpb24gcHJvY2Vzc2luZyBjb3N0Ci8vIE1VU1Qgc2V0IEdhc01ldGVyIHdpdGggdGhlIEZJUlNUIEFudGVEZWNvcmF0b3IuIEZhaWxpbmcgdG8gZG8gc28gd2lsbCBjYXVzZQovLyB0cmFuc2FjdGlvbnMgdG8gYmUgcHJvY2Vzc2VkIHdpdGggYW4gaW5maW5pdGUgZ2FzbWV0ZXIgYW5kIG9wZW4gYSBET1MgYXR0YWNrIHZlY3Rvci4KLy8gVXNlIGBhbnRlLlNldFVwQ29udGV4dERlY29yYXRvcmAgb3IgYSBjdXN0b20gRGVjb3JhdG9yIHdpdGggc2ltaWxhciBmdW5jdGlvbmFsaXR5LgpmdW5jIENoYWluQW50ZURlY29yYXRvcnMoY2hhaW4gLi4uQW50ZURlY29yYXRvcikgQW50ZUhhbmRsZXIgewoJaWYgKGNoYWluW2xlbihjaGFpbiktMV0gIT0gVGVybWluYXRvcnt9KSB7CgkJY2hhaW4gPSBhcHBlbmQoY2hhaW4sIFRlcm1pbmF0b3J7fSkKCX0KCglpZiBsZW4oY2hhaW4pID09IDEgewoJCXJldHVybiBmdW5jKGN0eCBDb250ZXh0LCB0eCBUeCwgc2ltdWxhdGUgYm9vbCkgKENvbnRleHQsIGVycm9yKSB7CgkJCXJldHVybiBjaGFpblswXS5BbnRlSGFuZGxlKGN0eCwgdHgsIHNpbXVsYXRlLCBuaWwpCgkJfQoJfQoKCXJldHVybiBmdW5jKGN0eCBDb250ZXh0LCB0eCBUeCwgc2ltdWxhdGUgYm9vbCkgKENvbnRleHQsIGVycm9yKSB7CgkJcmV0dXJuIGNoYWluWzBdLkFudGVIYW5kbGUoY3R4LCB0eCwgc2ltdWxhdGUsIENoYWluQW50ZURlY29yYXRvcnMoY2hhaW5bMTpdLi4uKSkKCX0KfQoKLy8gVGVybWluYXRvciBBbnRlRGVjb3JhdG9yIHdpbGwgZ2V0IGFkZGVkIHRvIHRoZSBjaGFpbiB0byBzaW1wbGlmeSBkZWNvcmF0b3IgY29kZQovLyBEb24ndCBuZWVkIHRvIGNoZWNrIGlmIG5leHQgPT0gbmlsIGZ1cnRoZXIgdXAgdGhlIGNoYWluCi8vICAgICAgICAgICAgICAgICAgICAgICAgX19fX19fCi8vICAgICAgICAgICAgICAgICAgICAgJmx0OygoKCgoKFxcXAovLyAgICAgICAgICAgICAgICAgICAgIC8gICAgICAuIH1cCi8vICAgICAgICAgICAgICAgICAgICAgOy0tLi4tLS5ffH0KLy8gIChcICAgICAgICAgICAgICAgICAnLS0vXC0tJyAgKQovLyAgIFxcICAgICAgICAgICAgICAgIHwgJy0nICA6J3wKLy8gICAgXFwgICAgICAgICAgICAgICAuIC09PS0gLi18Ci8vICAgICBcXCAgICAgICAgICAgICAgIFwuX18uJyAgIFwtLS5fCi8vICAgICBbXFwgICAgICAgICAgX18uLS18ICAgICAgIC8vICBfLyctLS4KLy8gICAgIFwgXFwgICAgICAgLictLl8gKCctLS0tLScvIF9fLyAgICAgIFwKLy8gICAgICBcIFxcICAgICAvICAgX18mZ3Q7fCAgICAgIHwgJy0tLiAgICAgICB8Ci8vICAgICAgIFwgXFwgICB8ICAgXCAgIHwgICAgIC8gICAgLyAgICAgICAvCi8vICAgICAgICBcICdcIC8gICAgIFwgIHwgICAgIHwgIF8vICAgICAgIC8KLy8gICAgICAgICBcICBcICAgICAgIFwgfCAgICAgfCAvICAgICAgICAvCi8vICAgc25kICAgIFwgIFwgICAgICBcICAgICAgICAvCnR5cGUgVGVybWluYXRvciBzdHJ1Y3R7fQoKLy8gU2ltcGx5IHJldHVybiBwcm92aWRlZCBDb250ZXh0IGFuZCBuaWwgZXJyb3IKZnVuYyAodCBUZXJtaW5hdG9yKSBBbnRlSGFuZGxlKGN0eCBDb250ZXh0LCBfIFR4LCBfIGJvb2wsIF8gQW50ZUhhbmRsZXIpIChDb250ZXh0LCBlcnJvcikgewoJcmV0dXJuIGN0eCwgbmlsCn0K"}})],1),e._v(" "),a("p",[e._v("The "),a("code",[e._v("AnteHandler")]),e._v(" is theoretically optional, but still a very important component of public blockchain networks. It serves 3 primary purposes:")]),e._v(" "),a("ul",[a("li",[e._v("Be a primary line of defense against spam and second line of defense (the first one being the mempool) against transaction replay with fees deduction and "),a("RouterLink",{attrs:{to:"/core/transactions.html#transaction-generation"}},[a("code",[e._v("sequence")])]),e._v(" checking.")],1),e._v(" "),a("li",[e._v("Perform preliminary "),a("em",[e._v("stateful")]),e._v(" validity checks like ensuring signatures are valid or that the sender has enough funds to pay for fees.")]),e._v(" "),a("li",[e._v("Play a role in the incentivisation of stakeholders via the collection of transaction fees.")])]),e._v(" "),a("p",[a("code",[e._v("baseapp")]),e._v(" holds an "),a("code",[e._v("anteHandler")]),e._v(" as paraemter, which is initialized in the "),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#application-constructor"}},[e._v("application's constructor")]),e._v(". The most widely used "),a("code",[e._v("anteHandler")]),e._v(" today is that of the "),a("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/master/x/auth/ante/ante.go",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("auth")]),e._v(" module"),a("OutboundLink")],1),e._v(".")],1),e._v(" "),a("p",[e._v("Click "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html#antehandler"}},[e._v("here")]),e._v(" for more on the "),a("code",[e._v("anteHandler")]),e._v(".")],1),e._v(" "),a("h3",{attrs:{id:"runmsgs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runmsgs"}},[e._v("#")]),e._v(" RunMsgs")]),e._v(" "),a("p",[a("code",[e._v("RunMsgs")]),e._v(" is called from "),a("code",[e._v("RunTx")]),e._v(" with "),a("code",[e._v("runTxModeCheck")]),e._v(" as parameter to check the existence of a route for each message the transaction, and with "),a("code",[e._v("runTxModeDeliver")]),e._v(" to actually process the "),a("code",[e._v("message")]),e._v("s.")]),e._v(" "),a("p",[e._v("First, it retreives the "),a("code",[e._v("message")]),e._v("'s "),a("code",[e._v("route")]),e._v(" using the "),a("code",[e._v("Msg.Route()")]),e._v(" method. Then, using the application's "),a("a",{attrs:{href:"#routing"}},[a("code",[e._v("router")])]),e._v(" and the "),a("code",[e._v("route")]),e._v(", it checks for the existence of a "),a("code",[e._v("handler")]),e._v(". At this point, if "),a("code",[e._v("mode == runTxModeCheck")]),e._v(", "),a("code",[e._v("RunMsgs")]),e._v(" returns. If instead "),a("code",[e._v("mode == runTxModeDeliver")]),e._v(", the "),a("RouterLink",{attrs:{to:"/building-modules/handler.html"}},[a("code",[e._v("handler")])]),e._v(" function for the message is executed, before "),a("code",[e._v("RunMsgs")]),e._v(" returns.")],1),e._v(" "),a("h2",{attrs:{id:"other-abci-messages"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#other-abci-messages"}},[e._v("#")]),e._v(" Other ABCI Messages")]),e._v(" "),a("h3",{attrs:{id:"initchain"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#initchain"}},[e._v("#")]),e._v(" InitChain")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://tendermint.com/docs/app-dev/abci-spec.html#initchain",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("InitChain")]),e._v(" ABCI message"),a("OutboundLink")],1),e._v(" is sent from the underlying Tendermint engine when the chain is first started. It is mainly used to "),a("strong",[e._v("initialize")]),e._v(" parameters and state like:")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://tendermint.com/docs/spec/abci/apps.html#consensus-parameters",target:"_blank",rel:"noopener noreferrer"}},[e._v("Consensus Parameters"),a("OutboundLink")],1),e._v(" via "),a("code",[e._v("setConsensusParams")]),e._v(".")]),e._v(" "),a("li",[a("a",{attrs:{href:"#volatile-states"}},[a("code",[e._v("checkState")]),e._v(" and "),a("code",[e._v("deliverState")])]),e._v(" via "),a("code",[e._v("setCheckState")]),e._v(" and "),a("code",[e._v("setDeliverState")]),e._v(".")]),e._v(" "),a("li",[e._v("The "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html#block-gas-meter"}},[e._v("block gas meter")]),e._v(", with infinite gas to process genesis transactions.")],1)]),e._v(" "),a("p",[e._v("Finally, the "),a("code",[e._v("InitChain(req abci.RequestInitChain)")]),e._v(" method of "),a("code",[e._v("baseapp")]),e._v(" calls the "),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#initchainer"}},[a("code",[e._v("initChainer()")])]),e._v(" of the application in order to initialize the main state of the application from the "),a("code",[e._v("genesis file")]),e._v(" and, if defined, call the "),a("RouterLink",{attrs:{to:"/building-modules/genesis.html#initgenesis"}},[a("code",[e._v("InitGenesis")])]),e._v(" function of each of the application's modules.")],1),e._v(" "),a("h3",{attrs:{id:"beginblock"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#beginblock"}},[e._v("#")]),e._v(" BeginBlock")]),e._v(" "),a("p",[e._v("The "),a("RouterLink",{attrs:{to:"/core/baseapp.html#https://tendermint.com/docs/app-dev/abci-spec.html#beginblock"}},[a("code",[e._v("BeginBlock")]),e._v(" ABCI message")]),e._v(" is sent from the underlying Tendermint engine when a block proposal created by the correct proposer is received, before "),a("a",{attrs:{href:"#delivertx"}},[a("code",[e._v("DeliverTx")])]),e._v(" is run for each transaction in the block. It allows developers to have logic be executed at the beginning of each block. In the Cosmos SDK, the "),a("code",[e._v("BeginBlock(req abci.RequestBeginBlock)")]),e._v(" method does the following:")],1),e._v(" "),a("ul",[a("li",[e._v("Initialize "),a("a",{attrs:{href:"#volatile-states"}},[a("code",[e._v("deliverState")])]),e._v(" with the latest header using the "),a("code",[e._v("req abci.RequestBeginBlock")]),e._v(" passed as parameter via the "),a("code",[e._v("setDeliverState")]),e._v(" function.\n"),a("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gc2V0RGVsaXZlclN0YXRlIHNldHMgdGhlIEJhc2VBcHAncyBkZWxpdmVyU3RhdGUgd2l0aCBhIGNhY2hlLXdyYXBwZWQgbXVsdGktc3RvcmUKLy8gKGkuZS4gYSBDYWNoZU11bHRpU3RvcmUpIGFuZCBhIG5ldyBDb250ZXh0IHdpdGggdGhlIGNhY2hlLXdyYXBwZWQgbXVsdGktc3RvcmUsCi8vIGFuZCBwcm92aWRlZCBoZWFkZXIuIEl0IGlzIHNldCBvbiBJbml0Q2hhaW4gYW5kIEJlZ2luQmxvY2sgYW5kIHNldCB0byBuaWwgb24KLy8gQ29tbWl0LgpmdW5jIChhcHAgKkJhc2VBcHApIHNldERlbGl2ZXJTdGF0ZShoZWFkZXIgYWJjaS5IZWFkZXIpIHsKCW1zIDo9IGFwcC5jbXMuQ2FjaGVNdWx0aVN0b3JlKCkKCWFwcC5kZWxpdmVyU3RhdGUgPSAmYW1wO3N0YXRlewoJCW1zOiAgbXMsCgkJY3R4OiBzZGsuTmV3Q29udGV4dChtcywgaGVhZGVyLCBmYWxzZSwgYXBwLmxvZ2dlciksCgl9Cn0="}}),e._v("\nThis function also resets the "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html#main-gas-meter"}},[e._v("main gas meter")]),e._v(".")],1),e._v(" "),a("li",[e._v("Initialize the "),a("RouterLink",{attrs:{to:"/basics/gas-fees.html#block-gas-meter"}},[e._v("block gas meter")]),e._v(" with the "),a("code",[e._v("maxGas")]),e._v(" limit. The "),a("code",[e._v("gas")]),e._v(" consumed within the block cannot go above "),a("code",[e._v("maxGas")]),e._v(". This parameter is defined in the application's consensus parameters.")],1),e._v(" "),a("li",[e._v("Run the application's "),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#beginblocker-and-endblock"}},[a("code",[e._v("beginBlocker()")])]),e._v(", which mainly runs the "),a("RouterLink",{attrs:{to:"/building-modules/beginblock-endblock.html#beginblock"}},[a("code",[e._v("BeginBlocker()")])]),e._v(" method of each of the application's modules.")],1),e._v(" "),a("li",[e._v("Set the "),a("a",{attrs:{href:"https://tendermint.com/docs/app-dev/abci-spec.html#voteinfo",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("VoteInfos")]),a("OutboundLink")],1),e._v(" of the application, i.e. the list of validators whose "),a("em",[e._v("precommit")]),e._v(" for the previous block was included by the proposer of the current block. This information is carried into the "),a("RouterLink",{attrs:{to:"/core/context.html"}},[a("code",[e._v("Context")])]),e._v(" so that it can be used during "),a("code",[e._v("DeliverTx")]),e._v(" and "),a("code",[e._v("EndBlock")]),e._v(".")],1)]),e._v(" "),a("h3",{attrs:{id:"endblock"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#endblock"}},[e._v("#")]),e._v(" EndBlock")]),e._v(" "),a("p",[e._v("The "),a("RouterLink",{attrs:{to:"/core/baseapp.html#https://tendermint.com/docs/app-dev/abci-spec.html#endblock"}},[a("code",[e._v("EndBlock")]),e._v(" ABCI message")]),e._v(" is sent from the underlying Tendermint engine after "),a("a",{attrs:{href:"#delivertx"}},[a("code",[e._v("DeliverTx")])]),e._v(" as been run for each transaction in the block. It allows developers to have logic be executed at the end of each block. In the Cosmos SDK, the bulk "),a("code",[e._v("EndBlock(req abci.RequestEndBlock)")]),e._v(" method is to run the application's "),a("RouterLink",{attrs:{to:"/basics/app-anatomy.html#beginblocker-and-endblock"}},[a("code",[e._v("EndBlocker()")])]),e._v(", which mainly runs the "),a("RouterLink",{attrs:{to:"/building-modules/beginblock-endblock.html#beginblock"}},[a("code",[e._v("EndBlocker()")])]),e._v(" method of each of the application's modules.")],1),e._v(" "),a("h3",{attrs:{id:"commit"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commit"}},[e._v("#")]),e._v(" Commit")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://tendermint.com/docs/app-dev/abci-spec.html#commit",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("Commit")]),e._v(" ABCI message"),a("OutboundLink")],1),e._v(" is sent from the underlying Tendermint engine after the full-node has received "),a("em",[e._v("precommits")]),e._v(" from 2/3+ of validators (weighted by voting power). On the "),a("code",[e._v("baseapp")]),e._v(" end, the "),a("code",[e._v("Commit(res abci.ResponseCommit)")]),e._v(" function is implemented to commit all the valid state transitions that occured during "),a("code",[e._v("BeginBlock")]),e._v(", "),a("code",[e._v("DeliverTx")]),e._v(" and "),a("code",[e._v("EndBlock")]),e._v(" and to reset state for the next block.")]),e._v(" "),a("p",[e._v("To commit state-transitions, the "),a("code",[e._v("Commit")]),e._v(" function calls the "),a("code",[e._v("Write()")]),e._v(" function on "),a("code",[e._v("deliverState.ms")]),e._v(", where "),a("code",[e._v("deliverState.ms")]),e._v(" is a cached multistore of the main store "),a("code",[e._v("app.cms")]),e._v(". Then, the "),a("code",[e._v("Commit")]),e._v(" function sets "),a("code",[e._v("checkState")]),e._v(" to the latest header (obtbained from "),a("code",[e._v("deliverState.ctx.BlockHeader")]),e._v(") and "),a("code",[e._v("deliverState")]),e._v(" to "),a("code",[e._v("nil")]),e._v(".")]),e._v(" "),a("p",[e._v("Finally, "),a("code",[e._v("Commit")]),e._v(" returns the hash of the commitment of "),a("code",[e._v("app.cms")]),e._v(" back to the underlying consensus engine. This hash is used as a reference in the header of the next block.")]),e._v(" "),a("h3",{attrs:{id:"info"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#info"}},[e._v("#")]),e._v(" Info")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://tendermint.com/docs/app-dev/abci-spec.html#info",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("Info")]),e._v(" ABCI message"),a("OutboundLink")],1),e._v(" is a simple query from the underlying consensus engine, notably used to sync the latter with the application during a handshake that happens on startup. When called, the "),a("code",[e._v("Info(res abci.ResponseInfo)")]),e._v(" function from "),a("code",[e._v("baseapp")]),e._v(" will return the application's name, version and the hash of the last commit of "),a("code",[e._v("app.cms")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"query"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#query"}},[e._v("#")]),e._v(" Query")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://tendermint.com/docs/app-dev/abci-spec.html#query",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("Query")]),e._v(" ABCI message"),a("OutboundLink")],1),e._v(" is used to serve queries received from the underlying consensus engine, including queries received via RPC like Tendermint RPC. It is the main entrypoint to build interfaces with the application. The application must respect a few rules when implementing the "),a("code",[e._v("Query")]),e._v(" method, which are outlined "),a("a",{attrs:{href:"https://tendermint.com/docs/app-dev/abci-spec.html#query",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("Each "),a("code",[e._v("query")]),e._v(" comes with a "),a("code",[e._v("path")]),e._v(", which contains multiple "),a("code",[e._v("string")]),e._v("s. By convention, the first element of the "),a("code",[e._v("path")]),e._v(" ("),a("code",[e._v("path[0]")]),e._v(") contains the category of "),a("code",[e._v("query")]),e._v(" ("),a("code",[e._v("app")]),e._v(", "),a("code",[e._v("p2p")]),e._v(", "),a("code",[e._v("store")]),e._v(" or "),a("code",[e._v("custom")]),e._v("). The "),a("code",[e._v("baseapp")]),e._v(" implementation of the "),a("code",[e._v("Query(req abci.RequestQuery)")]),e._v(" method is a simple dispatcher serving these 4 main categories of queries:")]),e._v(" "),a("ul",[a("li",[e._v("Application-related queries like querying the application's version, which are served via the "),a("code",[e._v("handleQueryApp")]),e._v(" method.")]),e._v(" "),a("li",[e._v("Direct queries to the multistore, which are served by the "),a("code",[e._v("handlerQueryStore")]),e._v(" method. These direct queryeis are different from custom queries which go through "),a("code",[e._v("app.queryRouter")]),e._v(", and are mainly used by third-party service provider like block explorers.")]),e._v(" "),a("li",[e._v("P2P queries, which are served via the "),a("code",[e._v("handleQueryP2P")]),e._v(" method. These queries return either "),a("code",[e._v("app.addrPeerFilter")]),e._v(" or "),a("code",[e._v("app.ipPeerFilter")]),e._v(" that contain the list of peers filtered by address or IP respectively. These lists are first initialized via "),a("code",[e._v("options")]),e._v(" in "),a("code",[e._v("baseapp")]),e._v("'s "),a("a",{attrs:{href:"#constructor"}},[e._v("constructor")]),e._v(".")]),e._v(" "),a("li",[e._v("Custom queries, which encompass most queries, are served via the "),a("code",[e._v("handleQueryCustom")]),e._v(" method. The "),a("code",[e._v("handleQueryCustom")]),e._v(" cache-wraps the multistore before using the "),a("code",[e._v("queryRoute")]),e._v(" obtained from "),a("a",{attrs:{href:"#query-routing"}},[a("code",[e._v("app.queryRouter")])]),e._v(" to map the query to the appropriate module's "),a("code",[e._v("querier")]),e._v(".")])]),e._v(" "),a("h2",{attrs:{hide:"",id:"next"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#next"}},[e._v("#")]),e._v(" Next")]),e._v(" "),a("p",{attrs:{hide:""}},[e._v("Learn more about "),a("RouterLink",{attrs:{to:"/core/transactions.html"}},[e._v("transactions")])],1)],1)}),[],!1,null,null,null);t.default=o.exports}}]);