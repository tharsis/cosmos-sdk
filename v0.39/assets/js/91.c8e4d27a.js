(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{872:function(e,a,t){"use strict";t.r(a);var n=t(1),l=Object(n.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"invariants"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#invariants"}},[e._v("#")]),e._v(" Invariants")]),e._v(" "),t("h2",{attrs:{hide:"",id:"pre-requisite-readings"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pre-requisite-readings"}},[e._v("#")]),e._v(" Pre-requisite Readings")]),e._v(" "),t("ul",[t("li",{attrs:{prereq:""}},[t("RouterLink",{attrs:{to:"/building-modules/keeper.html"}},[e._v("Keepers")])],1)]),e._v(" "),t("h2",{attrs:{id:"implementing-invariants"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#implementing-invariants"}},[e._v("#")]),e._v(" Implementing "),t("code",[e._v("Invariant")]),e._v("s")]),e._v(" "),t("p",[e._v("An "),t("code",[e._v("Invariant")]),e._v(" is a function that checks for a particular invariant within a module. Module "),t("code",[e._v("Invariant")]),e._v("s must follow the "),t("code",[e._v("Invariant")]),e._v("s type:")]),e._v(" "),t("p",[t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSB0eXBlcwoKaW1wb3J0ICZxdW90O2ZtdCZxdW90OwoKLy8gQW4gSW52YXJpYW50IGlzIGEgZnVuY3Rpb24gd2hpY2ggdGVzdHMgYSBwYXJ0aWN1bGFyIGludmFyaWFudC4KLy8gVGhlIGludmFyaWFudCByZXR1cm5zIGEgZGVzY3JpcHRpdmUgbWVzc2FnZSBhYm91dCB3aGF0IGhhcHBlbmVkCi8vIGFuZCBhIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBpbnZhcmlhbnQgaGFzIGJlZW4gYnJva2VuLgovLyBUaGUgc2ltdWxhdG9yIHdpbGwgdGhlbiBoYWx0IGFuZCBwcmludCB0aGUgbG9ncy4KdHlwZSBJbnZhcmlhbnQgZnVuYyhjdHggQ29udGV4dCkgKHN0cmluZywgYm9vbCkKCi8vIEludmFyaWFudHMgZGVmaW5lcyBhIGdyb3VwIG9mIGludmFyaWFudHMKdHlwZSBJbnZhcmlhbnRzIFtdSW52YXJpYW50CgovLyBleHBlY3RlZCBpbnRlcmZhY2UgZm9yIHJlZ2lzdGVyaW5nIGludmFyaWFudHMKdHlwZSBJbnZhcmlhbnRSZWdpc3RyeSBpbnRlcmZhY2UgewoJUmVnaXN0ZXJSb3V0ZShtb2R1bGVOYW1lLCByb3V0ZSBzdHJpbmcsIGludmFyIEludmFyaWFudCkKfQoKLy8gRm9ybWF0SW52YXJpYW50IHJldHVybnMgYSBzdGFuZGFyZGl6ZWQgaW52YXJpYW50IG1lc3NhZ2UuCmZ1bmMgRm9ybWF0SW52YXJpYW50KG1vZHVsZSwgbmFtZSwgbXNnIHN0cmluZykgc3RyaW5nIHsKCXJldHVybiBmbXQuU3ByaW50ZigmcXVvdDslczogJXMgaW52YXJpYW50XG4lc1xuJnF1b3Q7LCBtb2R1bGUsIG5hbWUsIG1zZykKfQo="}})],1),e._v(" "),t("p",[e._v("where the "),t("code",[e._v("string")]),e._v(" return value is the invariant message, which can be used when printing logs, and the "),t("code",[e._v("bool")]),e._v(" return value is the actual result of the invariant check.")]),e._v(" "),t("p",[e._v("In practice, each module implements "),t("code",[e._v("Invariant")]),e._v("s in a "),t("code",[e._v("./internal/keeper/invariants.go")]),e._v(" file within the module's folder. The standard is to implement one "),t("code",[e._v("Invariant")]),e._v(" function per logical grouping of invariants with the following model:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gRXhhbXBsZSBmb3IgYW4gSW52YXJpYW50IHRoYXQgY2hlY2tzIGJhbGFuY2UtcmVsYXRlZCBpbnZhcmlhbnRzCgpmdW5jIEJhbGFuY2VJbnZhcmlhbnRzKGsgS2VlcGVyKSBzZGsuSW52YXJpYW50IHsKCXJldHVybiBmdW5jKGN0eCBzZGsuQ29udGV4dCkgKHN0cmluZywgYm9vbCkgewogICAgICAgIC8vIEltcGxlbWVudCBjaGVja3MgZm9yIGJhbGFuY2UtcmVsYXRlZCBpbnZhcmlhbnRzCiAgICB9Cn0K"}}),e._v(" "),t("p",[e._v("Additionally, module developers should generally implement an "),t("code",[e._v("AllInvariants")]),e._v(" function that runs all the "),t("code",[e._v("Invariant")]),e._v("s functions of the module:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gQWxsSW52YXJpYW50cyBydW5zIGFsbCBpbnZhcmlhbnRzIG9mIHRoZSBtb2R1bGUuCi8vIEluIHRoaXMgZXhhbXBsZSwgdGhlIG1vZHVsZSBpbXBsZW1lbnRzIHR3byBJbnZhcmlhbnRzOiBCYWxhbmNlSW52YXJpYW50cyBhbmQgRGVwb3NpdHNJbnZhcmlhbnRzCgpmdW5jIEFsbEludmFyaWFudHMoayBLZWVwZXIpIHNkay5JbnZhcmlhbnQgewoKCXJldHVybiBmdW5jKGN0eCBzZGsuQ29udGV4dCkgKHN0cmluZywgYm9vbCkgewoJCXJlcywgc3RvcCA6PSBCYWxhbmNlSW52YXJpYW50cyhrKShjdHgpCgkJaWYgc3RvcCB7CgkJCXJldHVybiByZXMsIHN0b3AKCQl9CgoJCXJldHVybiBEZXBvc2l0c0ludmFyaWFudChrKShjdHgpCgl9Cn0K"}}),e._v(" "),t("p",[e._v("Finally, module developers need to implement the "),t("code",[e._v("RegisterInvariants")]),e._v(" method as part of the "),t("RouterLink",{attrs:{to:"/building-modules/module-manager.html#appmodule"}},[t("code",[e._v("AppModule")]),e._v(" interface")]),e._v(". Indeed, the "),t("code",[e._v("RegisterInvariants")]),e._v(" method of the module, implemented in the "),t("code",[e._v("module.go")]),e._v(" file, typically only defers the call to a "),t("code",[e._v("RegisterInvariants")]),e._v(" method implemented in "),t("code",[e._v("internal/keeper/invariants.go")]),e._v(". The "),t("code",[e._v("RegisterInvariants")]),e._v(" method registers a route for each "),t("code",[e._v("Invariant")]),e._v(" function in the "),t("a",{attrs:{href:"#invariant-registry"}},[t("code",[e._v("InvariantRegistry")])]),e._v(":")],1),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUmVnaXN0ZXJJbnZhcmlhbnRzIHJlZ2lzdGVycyBhbGwgc3Rha2luZyBpbnZhcmlhbnRzCmZ1bmMgUmVnaXN0ZXJJbnZhcmlhbnRzKGlyIHNkay5JbnZhcmlhbnRSZWdpc3RyeSwgayBLZWVwZXIpIHsKCWlyLlJlZ2lzdGVyUm91dGUodHlwZXMuTW9kdWxlTmFtZSwgJnF1b3Q7bW9kdWxlLWFjY291bnRzJnF1b3Q7LAoJCUJhbGFuY2VJbnZhcmlhbnRzKGspKQoJaXIuUmVnaXN0ZXJSb3V0ZSh0eXBlcy5Nb2R1bGVOYW1lLCAmcXVvdDtub25uZWdhdGl2ZS1wb3dlciZxdW90OywKCQlEZXBvc2l0c0ludmFyaWFudChrKSkKfQo="}}),e._v(" "),t("p",[e._v("For more, see an example of "),t("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/x/staking/keeper/invariants.go",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("Invariant")]),e._v("s implementation from the "),t("code",[e._v("staking")]),e._v(" module"),t("OutboundLink")],1),e._v(".")]),e._v(" "),t("h2",{attrs:{id:"invariant-registry"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#invariant-registry"}},[e._v("#")]),e._v(" Invariant Registry")]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("InvariantRegistry")]),e._v(" is a registry where the "),t("code",[e._v("Invariant")]),e._v("s of all the modules of an application are registered. There is only one "),t("code",[e._v("InvariantRegistry")]),e._v(" per "),t("strong",[e._v("application")]),e._v(", meaning module developers need not implement their own "),t("code",[e._v("InvariantRegistry")]),e._v(" when building a module. "),t("strong",[e._v("All module developers need to do is to register their modules' invariants in the "),t("code",[e._v("InvariantRegistry")]),e._v(", as explained in the section above")]),e._v(". The rest of this section gives more information on the "),t("code",[e._v("InvariantRegistry")]),e._v(" itself, and does not contain anything directly relevant to module developers.")]),e._v(" "),t("p",[e._v("At its core, the "),t("code",[e._v("InvariantRegistry")]),e._v(" is defined in the SDK as an interface:")]),e._v(" "),t("p",[t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gZXhwZWN0ZWQgaW50ZXJmYWNlIGZvciByZWdpc3RlcmluZyBpbnZhcmlhbnRzCnR5cGUgSW52YXJpYW50UmVnaXN0cnkgaW50ZXJmYWNlIHsKCVJlZ2lzdGVyUm91dGUobW9kdWxlTmFtZSwgcm91dGUgc3RyaW5nLCBpbnZhciBJbnZhcmlhbnQpCn0="}})],1),e._v(" "),t("p",[e._v("Typically, this interface is implemented in the "),t("code",[e._v("keeper")]),e._v(" of a specific module. The most used implementation of an "),t("code",[e._v("InvariantRegistry")]),e._v(" can be found in the "),t("code",[e._v("crisis")]),e._v(" module:")]),e._v(" "),t("p",[t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUmVnaXN0ZXJSb3V0ZSByZWdpc3RlciB0aGUgcm91dGVzIGZvciBlYWNoIG9mIHRoZSBpbnZhcmlhbnRzCmZ1bmMgKGsgKktlZXBlcikgUmVnaXN0ZXJSb3V0ZShtb2R1bGVOYW1lLCByb3V0ZSBzdHJpbmcsIGludmFyIHNkay5JbnZhcmlhbnQpIHsKCWludmFyUm91dGUgOj0gdHlwZXMuTmV3SW52YXJSb3V0ZShtb2R1bGVOYW1lLCByb3V0ZSwgaW52YXIpCglrLnJvdXRlcyA9IGFwcGVuZChrLnJvdXRlcywgaW52YXJSb3V0ZSkKfQ=="}})],1),e._v(" "),t("p",[e._v("The "),t("code",[e._v("InvariantRegistry")]),e._v(" is therefore typically instantiated by instantiating the "),t("code",[e._v("keeper")]),e._v(" of the "),t("code",[e._v("crisis")]),e._v(" module in the "),t("RouterLink",{attrs:{to:"/basics/app-anatomy.html#constructor-function"}},[e._v("application's constructor function")]),e._v(".")],1),e._v(" "),t("p",[t("code",[e._v("Invariant")]),e._v("s can be checked manually via "),t("RouterLink",{attrs:{to:"/building-modules/messages-and-queries.html"}},[t("code",[e._v("message")]),e._v("s")]),e._v(", but most often they are checked automatically at the end of each block. Here is an example from the "),t("code",[e._v("crisis")]),e._v(" module:")],1),e._v(" "),t("p",[t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gY2hlY2sgYWxsIHJlZ2lzdGVyZWQgaW52YXJpYW50cwpmdW5jIEVuZEJsb2NrZXIoY3R4IHNkay5Db250ZXh0LCBrIEtlZXBlcikgewoJaWYgay5JbnZDaGVja1BlcmlvZCgpID09IDAgfHwgY3R4LkJsb2NrSGVpZ2h0KCklaW50NjQoay5JbnZDaGVja1BlcmlvZCgpKSAhPSAwIHsKCQkvLyBza2lwIHJ1bm5pbmcgdGhlIGludmFyaWFudCBjaGVjawoJCXJldHVybgoJfQoJay5Bc3NlcnRJbnZhcmlhbnRzKGN0eCkKfQ=="}})],1),e._v(" "),t("p",[e._v("In both cases, if one of the "),t("code",[e._v("Invariant")]),e._v("s returns false, the "),t("code",[e._v("InvariantRegistry")]),e._v(" can trigger special logic (e.g. have the application panic and print the "),t("code",[e._v("Invariant")]),e._v("s message in the log).")]),e._v(" "),t("h2",{attrs:{hide:"",id:"next"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#next"}},[e._v("#")]),e._v(" Next")]),e._v(" "),t("p",{attrs:{hide:""}},[e._v("Learn about "),t("RouterLink",{attrs:{to:"/building-modules/genesis.html"}},[e._v("genesis functionalities")])],1)],1)}),[],!1,null,null,null);a.default=l.exports}}]);